<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morpho</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 44 44'%3E%3Cpath d='M22 22 C18 16,8 10,4 6 C2 4,1 8,3 12 C6 18,14 20,22 22Z' fill='%23d4820a'/%3E%3Cpath d='M22 22 C16 24,6 26,3 32 C1 36,4 40,8 38 C14 34,18 28,22 22Z' fill='%23f59e0b' opacity='.8'/%3E%3Cpath d='M22 22 C26 16,36 10,40 6 C42 4,43 8,41 12 C38 18,30 20,22 22Z' fill='%230d7377'/%3E%3Cpath d='M22 22 C28 24,38 26,41 32 C43 36,40 40,36 38 C30 34,26 28,22 22Z' fill='%2314a0a5' opacity='.8'/%3E%3Cellipse cx='22' cy='22' rx='2' ry='9' fill='%231a1814'/%3E%3Cline x1='21' y1='14' x2='16' y2='5' stroke='%231a1814' stroke-width='1' stroke-linecap='round'/%3E%3Cline x1='23' y1='14' x2='28' y2='5' stroke='%231a1814' stroke-width='1' stroke-linecap='round'/%3E%3Ccircle cx='16' cy='5' r='1.5' fill='%23d4820a'/%3E%3Ccircle cx='28' cy='5' r='1.5' fill='%230d7377'/%3E%3C/svg%3E">
<style>
@import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap');

:root {
  --sand: #f5f0e8;
  --cream: #faf8f3;
  --dark: #1a1814;
  --ink: #2d2a24;
  --muted: #8a8478;
  --line: #e0dbd0;
  --amber: #d4820a;
  --amber-light: #f59e0b;
  --amber-dim: rgba(212,130,10,0.12);
  --teal: #0d7377;
  --teal-light: #14a0a5;
  --teal-dim: rgba(13,115,119,0.12);
  --danger: #c0392b;
  --card-bg: white;
}

/* Dark mode */
body.dark-mode {
  --sand: #1e1c19;
  --cream: #141210;
  --dark: #f0ece4;
  --ink: #d8d3cb;
  --muted: #6b6660;
  --line: #2e2b27;
  --amber-dim: rgba(212,130,10,0.18);
  --teal-dim: rgba(13,115,119,0.18);
  --card-bg: #1a1814;
}

body.dark-mode select,
body.dark-mode .file-item,
body.dark-mode .github-link {
  background: #1e1c19;
  color: var(--ink);
}

body.dark-mode .github-link:hover {
  background: var(--dark);
  color: var(--cream);
}

body.dark-mode .center-divider {
  background: #1a1814;
}

body.dark-mode select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b6660' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}

body.dark-mode .panel-label {
  background: var(--cream);
}

body.dark-mode .drop-zone {
  background: var(--sand);
}

/* Dark mode toggle button */
.dark-toggle {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 14px;
  border: 1px solid var(--line);
  border-radius: 8px;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
  cursor: pointer;
  transition: all 0.2s ease;
}

.dark-toggle:hover {
  border-color: var(--muted);
  background: var(--sand);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--cream);
  color: var(--ink);
  min-height: 100vh;
}

/* ---- Texture overlay ---- */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 999;
  opacity: 0.5;
}

/* ---- Header ---- */
header {
  padding: 24px 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--line);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-mark {
  width: 44px;
  height: 44px;
  flex-shrink: 0;
}

.logo-text-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.logo-word {
  font-family: 'Instrument Serif', serif;
  font-size: 26px;
  color: var(--dark);
  letter-spacing: -0.02em;
  line-height: 1;
}

.logo-word em {
  font-style: italic;
  color: var(--amber);
}

.logo-sub {
  font-size: 11px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

/* GitHub link in header */
.github-link {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 16px;
  border: 1px solid var(--line);
  border-radius: 8px;
  text-decoration: none;
  color: var(--ink);
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s ease;
  background: white;
}

.github-link:hover {
  border-color: var(--dark);
  background: var(--dark);
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.github-link svg { transition: fill 0.2s; }
.github-link:hover svg path { fill: white; }

/* ---- Layout ---- */
.workspace {
  display: grid;
  grid-template-columns: 1fr 1fr;
  min-height: calc(100vh - 93px);
}

/* ---- Panel ---- */
.panel {
  padding: 48px;
  border-right: 1px solid var(--line);
  display: flex;
  flex-direction: column;
  gap: 28px;
  position: relative;
}

.panel:last-child { border-right: none; }

/* Vertical label */
.panel-label {
  position: absolute;
  top: 48px;
  right: -1px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  font-size: 10px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--muted);
  background: var(--cream);
  padding: 8px 6px;
  border: 1px solid var(--line);
  border-right: none;
}

.panel-title {
  font-family: 'Instrument Serif', serif;
  font-size: 36px;
  line-height: 1.1;
  color: var(--dark);
  letter-spacing: -0.02em;
}

.panel-title .from { color: var(--muted); font-style: italic; font-size: 28px; }
.panel-title .arrow { color: var(--line); font-size: 24px; }

/* ---- Drop zone ---- */
.drop-zone {
  border: 1.5px dashed var(--line);
  border-radius: 12px;
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s ease;
  background: var(--sand);
  position: relative;
  overflow: hidden;
}

.drop-zone.img-panel { --accent: var(--amber); --accent-dim: var(--amber-dim); }
.drop-zone.pdf-panel { --accent: var(--teal); --accent-dim: var(--teal-dim); }

.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--accent);
  background: var(--accent-dim);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.08);
}

.dz-icon {
  width: 56px; height: 56px;
  margin: 0 auto 16px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
}

.img-panel .dz-icon { background: var(--amber-dim); }
.pdf-panel .dz-icon { background: var(--teal-dim); }

.dz-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 4px;
}

.dz-sub {
  font-size: 12px;
  color: var(--muted);
  letter-spacing: 0.05em;
}

/* ---- Options ---- */
.options-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.opt-group {
  flex: 1;
  min-width: 120px;
}

.opt-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 6px;
}

select {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid var(--line);
  border-radius: 8px;
  background: white;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  color: var(--ink);
  cursor: pointer;
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a8478' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: border-color 0.2s;
}

select:focus { border-color: var(--amber); }

/* ---- File list ---- */
.file-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 240px;
  overflow-y: auto;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: white;
  border: 1px solid var(--line);
  border-radius: 8px;
  transition: all 0.2s;
  animation: item-in 0.25s ease;
}

@keyframes item-in {
  from { opacity: 0; transform: translateX(-8px); }
  to { opacity: 1; transform: translateX(0); }
}

.file-thumb {
  width: 36px; height: 36px;
  border-radius: 6px;
  object-fit: cover;
  flex-shrink: 0;
  background: var(--sand);
  border: 1px solid var(--line);
}

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-size { font-size: 11px; color: var(--muted); }

.file-remove {
  width: 24px; height: 24px;
  border: none;
  background: none;
  cursor: pointer;
  color: var(--muted);
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 4px;
  transition: all 0.15s;
  flex-shrink: 0;
}

.file-remove:hover { background: rgba(192,57,43,0.1); color: var(--danger); }

.sort-note {
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  font-style: italic;
}

/* ---- Progress ---- */
.progress-wrap {
  display: none;
}

.progress-bar-bg {
  height: 3px;
  background: var(--line);
  border-radius: 100px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-bar-fill {
  height: 100%;
  border-radius: 100px;
  transition: width 0.3s ease;
  width: 0%;
}

.img-panel .progress-bar-fill { background: linear-gradient(90deg, var(--amber), var(--amber-light)); }
.pdf-panel .progress-bar-fill { background: linear-gradient(90deg, var(--teal), var(--teal-light)); }

.progress-text {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
}

/* ---- Convert button ---- */
.btn-convert {
  padding: 14px 24px;
  border: none;
  border-radius: 10px;
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  letter-spacing: 0.01em;
}

.btn-convert:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

.btn-amber {
  background: var(--amber);
  color: white;
  box-shadow: 0 4px 20px rgba(212,130,10,0.25);
}
.btn-amber:not(:disabled):hover {
  background: #b8710a;
  transform: translateY(-1px);
  box-shadow: 0 8px 28px rgba(212,130,10,0.35);
}

.btn-teal {
  background: var(--teal);
  color: white;
  box-shadow: 0 4px 20px rgba(13,115,119,0.25);
}
.btn-teal:not(:disabled):hover {
  background: #0a5f63;
  transform: translateY(-1px);
  box-shadow: 0 8px 28px rgba(13,115,119,0.35);
}

/* ---- Results ---- */
.results-wrap {
  display: none;
}

.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
}

.result-thumb-wrap {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--line);
  background: var(--sand);
  aspect-ratio: 3/4;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.result-thumb-wrap:hover { transform: scale(1.03); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }

.result-thumb-wrap img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.result-page-label {
  position: absolute;
  bottom: 4px; left: 4px;
  font-size: 10px;
  font-weight: 600;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
}

.results-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-small {
  padding: 9px 16px;
  border: 1px solid var(--line);
  border-radius: 8px;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  background: white;
  color: var(--ink);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-small:hover { border-color: var(--muted); background: var(--sand); }

.btn-small.primary-amber { background: var(--amber); border-color: var(--amber); color: white; }
.btn-small.primary-amber:hover { background: #b8710a; }
.btn-small.primary-teal { background: var(--teal); border-color: var(--teal); color: white; }
.btn-small.primary-teal:hover { background: #0a5f63; }

/* ---- Error ---- */
.error-msg {
  padding: 12px 16px;
  background: rgba(192,57,43,0.08);
  border: 1px solid rgba(192,57,43,0.25);
  border-radius: 8px;
  font-size: 13px;
  color: var(--danger);
  display: none;
}

/* ---- Divider ---- */
.center-divider {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 40px; height: 40px;
  background: var(--cream);
  border: 1px solid var(--line);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  color: var(--muted);
  z-index: 10;
  pointer-events: none;
}

/* ---- Responsive ---- */
@media (max-width: 768px) {
  header { padding: 16px 24px; }
  .github-link span { display: none; }
  .workspace { grid-template-columns: 1fr; }
  .panel { border-right: none; border-bottom: 1px solid var(--line); padding: 32px 24px; }
  .panel:last-child { border-bottom: none; }
  .panel-label { display: none; }
  .center-divider { display: none; }
}

/* Drag reorder */
.file-item.dragging {
  opacity: 0.4;
  border: 1.5px dashed var(--amber);
}
.file-item.drag-target {
  border-color: var(--amber);
  background: var(--amber-dim);
}
.file-item {
  cursor: grab;
}
.file-item:active {
  cursor: grabbing;
}

/* Range input */
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  height: 4px;
  background: var(--line);
  border-radius: 100px;
  outline: none;
  margin-top: 8px;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: var(--amber);
  border-radius: 50%;
  cursor: pointer;
}

/* Page number badge preview */
.pagenum-preview {
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
  font-style: italic;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--line); border-radius: 100px; }

/* ---- Modal overlay ---- */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }

.modal-box {
  background: var(--cream);
  border: 1px solid var(--line);
  border-radius: 16px;
  padding: 32px;
  max-width: 520px;
  width: 90vw;
  position: relative;
  box-shadow: 0 24px 80px rgba(0,0,0,0.2);
}

.modal-title {
  font-family: 'Instrument Serif', serif;
  font-size: 24px;
  color: var(--dark);
  margin-bottom: 20px;
}

.modal-close {
  position: absolute;
  top: 16px; right: 16px;
  width: 32px; height: 32px;
  border: none;
  background: var(--sand);
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  color: var(--muted);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.modal-close:hover { background: var(--line); color: var(--dark); }

/* ---- Crop modal ---- */
#cropContainer {
  position: relative;
  width: 100%;
  background: var(--sand);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 16px;
  cursor: crosshair;
  user-select: none;
  border: 1px solid var(--line);
}
#cropContainer img {
  display: block;
  max-width: 100%;
  max-height: 380px;
  margin: 0 auto;
  pointer-events: none;
}
#cropSelection {
  position: absolute;
  border: 2px solid var(--amber);
  background: rgba(212,130,10,0.12);
  display: none;
  pointer-events: none;
}
.crop-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ---- Password modal ---- */
.pw-field {
  position: relative;
  margin-bottom: 12px;
}
.pw-field input {
  width: 100%;
  padding: 11px 40px 11px 14px;
  border: 1px solid var(--line);
  border-radius: 8px;
  font-family: 'Outfit', sans-serif;
  font-size: 14px;
  color: var(--ink);
  background: white;
  outline: none;
  transition: border-color 0.2s;
}
.pw-field input:focus { border-color: var(--teal); }
body.dark-mode .pw-field input { background: var(--sand); }
.pw-eye {
  position: absolute;
  right: 10px; top: 50%;
  transform: translateY(-50%);
  background: none; border: none;
  cursor: pointer; font-size: 16px;
  color: var(--muted);
}
.pw-strength {
  height: 3px;
  border-radius: 100px;
  margin-bottom: 12px;
  transition: all 0.3s;
  background: var(--line);
}
.pw-strength.weak { background: #e74c3c; width: 33%; }
.pw-strength.medium { background: #f39c12; width: 66%; }
.pw-strength.strong { background: #27ae60; width: 100%; }

/* ---- PDF Merge section ---- */
.merge-section {
  border-top: 1px solid var(--line);
  margin-top: 8px;
  padding-top: 20px;
}
.merge-title {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}
.merge-drop {
  border: 1.5px dashed var(--line);
  border-radius: 10px;
  padding: 18px;
  text-align: center;
  cursor: pointer;
  background: var(--sand);
  transition: all 0.2s;
  font-size: 13px;
  color: var(--muted);
}
.merge-drop:hover, .merge-drop.drag-over {
  border-color: var(--teal);
  background: var(--teal-dim);
  color: var(--teal);
}
.merge-file-list {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-top: 10px;
  max-height: 180px;
  overflow-y: auto;
}
.merge-file-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: white;
  border: 1px solid var(--line);
  border-radius: 7px;
  font-size: 12px;
  cursor: grab;
  animation: item-in 0.2s ease;
}
body.dark-mode .merge-file-item { background: var(--sand); }
.merge-file-item.dragging { opacity: 0.4; border-color: var(--teal); }
.merge-file-item.drag-target { border-color: var(--teal); background: var(--teal-dim); }
.merge-file-icon { font-size: 16px; flex-shrink: 0; }
.merge-file-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--dark); }
.merge-file-size { color: var(--muted); flex-shrink: 0; }
.merge-file-remove { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 14px; padding: 2px 4px; border-radius: 4px; transition: all 0.15s; }
.merge-file-remove:hover { color: var(--danger); background: rgba(192,57,43,0.1); }

/* ---- Resize options ---- */
.resize-row {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 6px;
}
.resize-row input[type="number"] {
  width: 80px;
  padding: 8px 10px;
  border: 1px solid var(--line);
  border-radius: 7px;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s;
  background: white;
}
body.dark-mode .resize-row input[type="number"] { background: var(--sand); }
.resize-row input[type="number"]:focus { border-color: var(--amber); }
.resize-sep { color: var(--muted); font-size: 12px; }
.resize-lock {
  width: 28px; height: 28px;
  border: 1px solid var(--line);
  border-radius: 6px;
  background: var(--sand);
  cursor: pointer;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.resize-lock.locked { border-color: var(--amber); background: var(--amber-dim); }

/* Feature action buttons in file list */
.file-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}
.file-action-btn {
  width: 26px; height: 26px;
  border: 1px solid var(--line);
  border-radius: 5px;
  background: var(--sand);
  cursor: pointer;
  font-size: 12px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
  color: var(--muted);
}
.file-action-btn:hover { border-color: var(--amber); color: var(--amber); background: var(--amber-dim); }

/* ---- Firebase Auth UI ---- */
.auth-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}
.auth-avatar {
  width: 32px; height: 32px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--line);
}
.auth-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
  max-width: 120px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.btn-google {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  border: 1px solid var(--line);
  border-radius: 8px;
  background: white;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--ink);
  cursor: pointer;
  transition: all 0.2s ease;
}
.btn-google:hover {
  border-color: #4285F4;
  box-shadow: 0 2px 12px rgba(66,133,244,0.15);
  transform: translateY(-1px);
}
body.dark-mode .btn-google {
  background: var(--sand);
  color: var(--ink);
}
.btn-signout {
  padding: 6px 12px;
  border: 1px solid var(--line);
  border-radius: 7px;
  background: transparent;
  font-family: 'Outfit', sans-serif;
  font-size: 12px;
  color: var(--muted);
  cursor: pointer;
  transition: all 0.15s;
}
.btn-signout:hover {
  border-color: var(--danger);
  color: var(--danger);
  background: rgba(192,57,43,0.07);
}

/* Auth modal */
#authModal .modal-box {
  max-width: 380px;
  text-align: center;
  padding: 40px 32px;
}
.auth-logo-wrap {
  margin-bottom: 20px;
}
.auth-modal-title {
  font-family: 'Instrument Serif', serif;
  font-size: 26px;
  color: var(--dark);
  margin-bottom: 6px;
}
.auth-modal-sub {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 28px;
  line-height: 1.5;
}
.btn-google-large {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  width: 100%;
  padding: 13px 20px;
  border: 1.5px solid var(--line);
  border-radius: 10px;
  background: white;
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--ink);
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 12px;
}
.btn-google-large:hover {
  border-color: #4285F4;
  box-shadow: 0 4px 20px rgba(66,133,244,0.18);
  transform: translateY(-1px);
}
body.dark-mode .btn-google-large {
  background: var(--sand);
}
.auth-skip {
  font-size: 12px;
  color: var(--muted);
  cursor: pointer;
  text-decoration: underline;
  background: none;
  border: none;
  font-family: 'Outfit', sans-serif;
}
.auth-skip:hover { color: var(--ink); }
.auth-divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 16px 0;
  font-size: 11px;
  color: var(--muted);
}
.auth-divider::before, .auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--line);
}

#toastContainer {
  position: fixed;
  bottom: 24px; right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--dark);
  color: var(--cream);
  padding: 11px 18px;
  border-radius: 10px;
  font-size: 13px;
  font-family: 'Outfit', sans-serif;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18);
  animation: toastIn 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 300px;
  pointer-events: auto;
}
.toast.success { border-left: 3px solid #27ae60; }
.toast.error   { border-left: 3px solid #e74c3c; }
.toast.info    { border-left: 3px solid var(--amber); }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(20px) scale(0.95); }
  to   { opacity: 1; transform: translateX(0) scale(1); }
}

/* ---- Preview modal ---- */
#previewModal .modal-box { max-width: 90vw; width: 800px; padding: 20px; }
#previewImg { max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; display: block; margin: 0 auto; }
.preview-nav { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; }
.preview-nav button { padding: 7px 16px; border: 1px solid var(--line); border-radius: 7px; background: var(--sand); font-family: 'Outfit', sans-serif; font-size: 13px; cursor: pointer; color: var(--ink); transition: all 0.15s; }
.preview-nav button:hover { border-color: var(--amber); background: var(--amber-dim); }
.preview-counter { font-size: 13px; color: var(--muted); }

/* ---- Image editing ---- */
.edit-section { border-top: 1px solid var(--line); margin-top: 8px; padding-top: 18px; }
.edit-title { font-size: 13px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
.slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.slider-label { font-size: 12px; color: var(--muted); width: 72px; flex-shrink: 0; }
.slider-row input[type="range"] { flex: 1; margin: 0; }
.slider-val { font-size: 12px; color: var(--ink); width: 34px; text-align: right; flex-shrink: 0; }
.filter-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
.filter-chip { padding: 5px 12px; border: 1px solid var(--line); border-radius: 20px; font-size: 12px; cursor: pointer; background: var(--sand); color: var(--ink); transition: all 0.15s; }
.filter-chip.active, .filter-chip:hover { border-color: var(--amber); background: var(--amber-dim); color: var(--amber); }

/* ---- Watermark ---- */
.watermark-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
.watermark-row input[type="text"] { flex: 1; padding: 8px 12px; border: 1px solid var(--line); border-radius: 7px; font-family: 'Outfit', sans-serif; font-size: 13px; color: var(--ink); background: white; outline: none; transition: border-color 0.2s; }
.watermark-row input[type="text"]:focus { border-color: var(--amber); }
body.dark-mode .watermark-row input { background: var(--sand); }
body.dark-mode #pdfOutputName { background: var(--sand) !important; }

/* ---- PDF Tools ---- */
.pdf-tools-section { border-top: 1px solid var(--line); margin-top: 8px; padding-top: 18px; }
.pdf-tools-title { font-size: 13px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }
.tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.tool-card { border: 1px solid var(--line); border-radius: 10px; padding: 14px; cursor: pointer; background: var(--sand); transition: all 0.2s; text-align: center; }
.tool-card:hover { border-color: var(--teal); background: var(--teal-dim); transform: translateY(-1px); }
.tool-card.active-tool { border-color: var(--teal); background: var(--teal-dim); }
.tool-card-icon { font-size: 22px; margin-bottom: 5px; }
.tool-card-label { font-size: 12px; font-weight: 600; color: var(--dark); }
.tool-card-sub { font-size: 10px; color: var(--muted); margin-top: 2px; }

/* ---- Tool sub-panels ---- */
.tool-subpanel { display: none; margin-top: 12px; }
.tool-subpanel.show { display: block; }
.extract-output textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid var(--line); border-radius: 8px; font-family: 'Outfit', sans-serif; font-size: 12px; color: var(--ink); background: white; resize: vertical; outline: none; }
body.dark-mode .extract-output textarea { background: var(--sand); }

/* ---- Shortcuts panel ---- */
.shortcuts-fab {
  position: fixed;
  bottom: 24px; left: 24px;
  width: 40px; height: 40px;
  background: var(--dark);
  color: var(--cream);
  border: none;
  border-radius: 50%;
  font-size: 16px;
  cursor: pointer;
  z-index: 500;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  transition: all 0.2s;
}
.shortcuts-fab:hover { transform: scale(1.08); }
.shortcuts-panel {
  display: none;
  position: fixed;
  bottom: 72px; left: 24px;
  background: var(--dark);
  color: var(--cream);
  border-radius: 12px;
  padding: 18px 22px;
  z-index: 500;
  font-size: 12px;
  box-shadow: 0 12px 48px rgba(0,0,0,0.25);
  min-width: 240px;
}
.shortcuts-panel.show { display: block; }
.shortcut-row { display: flex; justify-content: space-between; gap: 20px; padding: 4px 0; color: rgba(255,255,255,0.85); }
.shortcut-key { font-family: monospace; background: rgba(255,255,255,0.12); padding: 1px 7px; border-radius: 4px; color: white; }
.shortcuts-panel h4 { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-bottom: 10px; }

@media (max-width: 768px) {
  .tool-grid { grid-template-columns: 1fr; }
  #toastContainer { bottom: 12px; right: 12px; left: 12px; }
  .toast { max-width: 100%; }
  .shortcuts-fab, .shortcuts-panel { display: none !important; }
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <!-- Morpho Butterfly SVG Logo -->
    <svg class="logo-mark" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Left wing top -->
      <path d="M22 22 C18 16, 8 10, 4 6 C2 4, 1 8, 3 12 C6 18, 14 20, 22 22Z" fill="#d4820a" opacity="0.9"/>
      <!-- Left wing bottom -->
      <path d="M22 22 C16 24, 6 26, 3 32 C1 36, 4 40, 8 38 C14 34, 18 28, 22 22Z" fill="#f59e0b" opacity="0.75"/>
      <!-- Right wing top -->
      <path d="M22 22 C26 16, 36 10, 40 6 C42 4, 43 8, 41 12 C38 18, 30 20, 22 22Z" fill="#0d7377" opacity="0.9"/>
      <!-- Right wing bottom -->
      <path d="M22 22 C28 24, 38 26, 41 32 C43 36, 40 40, 36 38 C30 34, 26 28, 22 22Z" fill="#14a0a5" opacity="0.75"/>
      <!-- Wing shimmer dots -->
      <circle cx="11" cy="14" r="2" fill="white" opacity="0.4"/>
      <circle cx="33" cy="14" r="2" fill="white" opacity="0.4"/>
      <circle cx="9" cy="32" r="1.5" fill="white" opacity="0.3"/>
      <circle cx="35" cy="32" r="1.5" fill="white" opacity="0.3"/>
      <!-- Body -->
      <ellipse cx="22" cy="22" rx="2" ry="9" fill="#1a1814"/>
      <!-- Antennae -->
      <path d="M21 14 Q18 8 16 5" stroke="#1a1814" stroke-width="1" stroke-linecap="round" fill="none"/>
      <path d="M23 14 Q26 8 28 5" stroke="#1a1814" stroke-width="1" stroke-linecap="round" fill="none"/>
      <circle cx="16" cy="5" r="1.2" fill="#d4820a"/>
      <circle cx="28" cy="5" r="1.2" fill="#0d7377"/>
    </svg>

    <div class="logo-text-group">
      <div class="logo-word">Morph<em>o</em></div>
      <div class="logo-sub">Image ‚Üî PDF Converter</div>
    </div>
  </div>

  <div class="header-right">
    <!-- Auth UI -->
    <div class="auth-bar" id="authBar">
      <!-- Shown when logged out -->
      <button class="btn-google" id="btnSignIn" onclick="openAuthModal()">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in
      </button>
      <!-- Shown when logged in -->
      <div id="userInfo" style="display:none; align-items:center; gap:8px; display:none;">
        <img class="auth-avatar" id="userAvatar" src="" alt="avatar">
        <span class="auth-name" id="userName"></span>
        <button class="btn-signout" onclick="signOut()">Sign out</button>
      </div>
    </div>

    <button class="dark-toggle" id="darkToggle" onclick="toggleDarkMode()">
      <span id="darkIcon">üåô</span>
      <span id="darkLabel">Dark</span>
    </button>
    <a class="github-link" href="https://github.com/kalharanonis0" target="_blank" rel="noopener">
      <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z" fill="#2d2a24"/>
      </svg>
      <span>View on GitHub</span>
    </a>
  </div>
</header>

<div class="center-divider">‚áÑ</div>

<div class="workspace">

  <!-- ===== LEFT: Image ‚Üí PDF ===== -->
  <div class="panel" id="imgPanel">
    <div class="panel-label">Image ‚Üí PDF</div>

    <div class="panel-title">
      <span class="from">Image</span><br>
      <span class="arrow">‚Üì</span> PDF
    </div>

    <!-- Drop zone -->
    <div class="drop-zone img-panel" id="imgDropZone" onclick="document.getElementById('imgInput').click()">
      <div class="dz-icon">üñº</div>
      <div class="dz-title">Drop images here</div>
      <div class="dz-sub">JPG ¬∑ PNG ¬∑ WEBP ¬∑ BMP ¬∑ GIF</div>
    </div>
    <input type="file" id="imgInput" accept="image/*" multiple style="display:none">

    <!-- File list -->
    <div id="imgFileList" class="file-list" style="display:none"></div>
    <div class="sort-note" id="imgSortNote" style="display:none">‚Üï Drag files to reorder</div>

    <!-- Options -->
    <div class="options-row" id="imgOptions" style="display:none">
      <div class="opt-group">
        <div class="opt-label">Page Size</div>
        <select id="imgPageSize">
          <option value="a4">A4</option>
          <option value="letter">Letter</option>
          <option value="fit">Fit to Image</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Orientation</div>
        <select id="imgOrientation">
          <option value="auto">Auto</option>
          <option value="portrait">Portrait</option>
          <option value="landscape">Landscape</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Image Fit</div>
        <select id="imgFit">
          <option value="contain">Fit (contain)</option>
          <option value="fill">Fill page</option>
          <option value="original">Original size</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Image Quality</div>
        <select id="imgQuality">
          <option value="1">Max (lossless)</option>
          <option value="0.9" selected>High (90%)</option>
          <option value="0.7">Medium (70%)</option>
          <option value="0.5">Low (50%)</option>
        </select>
      </div>
    </div>
    <div class="options-row" id="imgOptions2" style="display:none">
      <div class="opt-group" style="flex:1">
        <div class="opt-label">Page Numbers</div>
        <select id="imgPageNumbers">
          <option value="none">None</option>
          <option value="bottom-center">Bottom Center</option>
          <option value="bottom-right">Bottom Right</option>
          <option value="top-center">Top Center</option>
        </select>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-wrap img-panel" id="imgProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="imgProgressBar"></div></div>
      <div class="progress-text" id="imgProgressText">Processing...</div>
    </div>

    <div class="error-msg" id="imgError"></div>

    <!-- Convert button -->
    <button class="btn-convert btn-amber" id="imgConvertBtn" onclick="convertImagesToPDF()" disabled>
      ‚ú¶ Convert to PDF
    </button>

    <!-- Results -->
    <div class="results-wrap" id="imgResults">
      <!-- PDF Rename -->
      <div style="margin-bottom:10px;">
        <div class="opt-label" style="margin-bottom:5px;">üìù PDF File Name</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" id="pdfOutputName" placeholder="e.g. my-document" value="morpho-converted"
            style="flex:1; padding:9px 12px; border:1px solid var(--line); border-radius:7px;
            font-family:'Outfit',sans-serif; font-size:13px; color:var(--ink); background:white; outline:none;
            transition: border-color 0.2s;">
          <span style="font-size:13px; color:var(--muted); flex-shrink:0;">.pdf</span>
        </div>
      </div>
      <div class="results-actions">
        <button class="btn-small primary-amber" id="imgDownloadBtn">‚Üì Download PDF</button>
        <button class="btn-small" onclick="resetImg()">‚úï Clear</button>
      </div>
    </div>

    <!-- PDF Password Protection -->
    <div class="options-row" id="imgPasswordRow" style="display:none; margin-top: 4px;">
      <div class="opt-group" style="flex:1; display:flex; align-items:center; gap:10px;">
        <label style="display:flex; align-items:center; gap:7px; cursor:pointer; font-size:13px; color:var(--ink);">
          <input type="checkbox" id="imgPasswordEnabled" onchange="togglePasswordField()" style="accent-color:var(--amber); width:14px; height:14px;">
          üîí Password protect PDF
        </label>
        <div id="imgPasswordFieldWrap" style="display:none; flex:1;">
          <div class="pw-field" style="margin:0;">
            <input type="password" id="imgPasswordInput" placeholder="Enter password‚Ä¶" oninput="updatePwStrength()">
            <button class="pw-eye" onclick="togglePwEye()" id="pwEyeBtn">üëÅ</button>
          </div>
          <div class="pw-strength" id="pwStrength"></div>
        </div>
      </div>
    </div>

    <!-- Image Editing Section -->
    <div class="edit-section" id="imgEditSection" style="display:none">
      <div class="edit-title">üé® Image Adjustments</div>

      <div class="filter-chips" id="filterChips">
        <div class="filter-chip active" data-filter="none" onclick="setFilter(this,'none')">Original</div>
        <div class="filter-chip" data-filter="grayscale" onclick="setFilter(this,'grayscale(100%)')">Grayscale</div>
        <div class="filter-chip" data-filter="sepia" onclick="setFilter(this,'sepia(80%)')">Sepia</div>
        <div class="filter-chip" data-filter="invert" onclick="setFilter(this,'invert(100%)')">Invert</div>
        <div class="filter-chip" data-filter="blur" onclick="setFilter(this,'blur(1px)')">Soft</div>
      </div>

      <div class="slider-row">
        <span class="slider-label">Brightness</span>
        <input type="range" id="sliderBright" min="0" max="200" value="100" oninput="updateSliderVal('bright')">
        <span class="slider-val" id="valBright">100%</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Contrast</span>
        <input type="range" id="sliderContrast" min="0" max="200" value="100" oninput="updateSliderVal('contrast')">
        <span class="slider-val" id="valContrast">100%</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Saturation</span>
        <input type="range" id="sliderSat" min="0" max="200" value="100" oninput="updateSliderVal('sat')">
        <span class="slider-val" id="valSat">100%</span>
      </div>

      <div style="margin-top:4px;">
        <div class="opt-label">Watermark Text</div>
        <div class="watermark-row">
          <input type="text" id="watermarkText" placeholder="e.g. CONFIDENTIAL">
          <select id="watermarkPos" style="padding:8px 10px; border:1px solid var(--line); border-radius:7px; font-family:'Outfit',sans-serif; font-size:12px; color:var(--ink); background:white; outline:none;">
            <option value="center">Center</option>
            <option value="bottom-right">Bottom Right</option>
            <option value="top-left">Top Left</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT: PDF ‚Üí Image ===== -->
  <div class="panel" id="pdfPanel">

    <div class="panel-title">
      <span class="from">PDF</span><br>
      <span class="arrow">‚Üì</span> Images
    </div>

    <!-- Drop zone -->
    <div class="drop-zone pdf-panel" id="pdfDropZone" onclick="document.getElementById('pdfInput').click()">
      <div class="dz-icon">üìÑ</div>
      <div class="dz-title">Drop a PDF here</div>
      <div class="dz-sub">One PDF file</div>
    </div>
    <input type="file" id="pdfInput" accept=".pdf,application/pdf" style="display:none">

    <!-- Options -->
    <div class="options-row" id="pdfOptions" style="display:none">
      <div class="opt-group">
        <div class="opt-label">Output Format</div>
        <select id="pdfFormat">
          <option value="jpeg">JPEG</option>
          <option value="png">PNG</option>
          <option value="webp">WEBP</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Quality</div>
        <select id="pdfQuality">
          <option value="1.5">Standard (1.5x)</option>
          <option value="2" selected>High (2x)</option>
          <option value="3">Ultra (3x)</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Pages</div>
        <select id="pdfPages">
          <option value="all">All pages</option>
          <option value="first">First page only</option>
          <option value="range">Custom range</option>
        </select>
      </div>
    </div>

    <div id="pdfRangeWrap" style="display:none">
      <div class="opt-label" style="margin-bottom:6px">Page Range (e.g. 1-3, 5)</div>
      <input type="text" id="pdfRangeInput" placeholder="1-3, 5, 7"
        style="width:100%;padding:9px 12px;border:1px solid var(--line);border-radius:8px;font-family:'Outfit',sans-serif;font-size:13px;color:var(--ink);outline:none;">
    </div>

    <!-- Progress -->
    <div class="progress-wrap pdf-panel" id="pdfProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="pdfProgressBar"></div></div>
      <div class="progress-text" id="pdfProgressText">Rendering pages...</div>
    </div>

    <div class="error-msg" id="pdfError"></div>

    <!-- Convert button -->
    <button class="btn-convert btn-teal" id="pdfConvertBtn" onclick="convertPDFToImages()" disabled>
      ‚ú¶ Convert to Images
    </button>

    <!-- Results -->
    <div class="results-wrap" id="pdfResults">
      <div class="result-grid" id="pdfResultGrid"></div>
      <div class="results-actions" style="margin-top:12px">
        <button class="btn-small primary-teal" id="pdfDownloadAllBtn">‚Üì Download All (.zip)</button>
        <button class="btn-small" onclick="resetPDF()">‚úï Clear</button>
      </div>
    </div>

    <!-- PDF Tools Section -->
    <div class="pdf-tools-section" id="pdfToolsSection" style="display:none">
      <div class="pdf-tools-title">üõ† PDF Tools</div>
      <div class="tool-grid">
        <div class="tool-card" id="toolRotate" onclick="togglePdfTool('rotate')">
          <div class="tool-card-icon">üîÑ</div>
          <div class="tool-card-label">Rotate Pages</div>
          <div class="tool-card-sub">Rotate all or specific pages</div>
        </div>
        <div class="tool-card" id="toolSplit" onclick="togglePdfTool('split')">
          <div class="tool-card-icon">‚úÇ</div>
          <div class="tool-card-label">Split PDF</div>
          <div class="tool-card-sub">Extract page range as new PDF</div>
        </div>
        <div class="tool-card" id="toolExtract" onclick="togglePdfTool('extract')">
          <div class="tool-card-icon">üìù</div>
          <div class="tool-card-label">Extract Text</div>
          <div class="tool-card-sub">Copy text from all pages</div>
        </div>
        <div class="tool-card" id="toolInfo" onclick="togglePdfTool('info')">
          <div class="tool-card-icon">‚Ñπ</div>
          <div class="tool-card-label">PDF Info</div>
          <div class="tool-card-sub">Pages, size, metadata</div>
        </div>
      </div>

      <!-- Rotate sub-panel -->
      <div class="tool-subpanel" id="subRotate">
        <div class="opt-label" style="margin-bottom:8px">Rotation</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-small" onclick="rotatePDF(90)">‚Üª 90¬∞ Right</button>
          <button class="btn-small" onclick="rotatePDF(-90)">‚Ü∫ 90¬∞ Left</button>
          <button class="btn-small" onclick="rotatePDF(180)">‚Üï 180¬∞</button>
        </div>
        <div style="margin-top:10px; font-size:11px; color:var(--muted)">Applies to all pages in the current PDF</div>
        <div class="error-msg" id="rotateError" style="margin-top:8px;"></div>
      </div>

      <!-- Split sub-panel -->
      <div class="tool-subpanel" id="subSplit">
        <div class="opt-label" style="margin-bottom:8px">Pages to Extract</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" id="splitRange" placeholder="e.g. 1-3, 5"
            style="flex:1; padding:9px 12px; border:1px solid var(--line); border-radius:7px; font-family:'Outfit',sans-serif; font-size:13px; color:var(--ink); outline:none;">
          <button class="btn-small primary-teal" onclick="splitPDF()">Split & Download</button>
        </div>
        <div class="error-msg" id="splitError" style="margin-top:8px;"></div>
      </div>

      <!-- Extract text sub-panel -->
      <div class="tool-subpanel" id="subExtract">
        <button class="btn-small primary-teal" onclick="extractText()" style="margin-bottom:10px;">Extract Text</button>
        <div id="extractOutputWrap" style="display:none;">
          <textarea id="extractOutput" readonly placeholder="Extracted text will appear here‚Ä¶"></textarea>
          <div style="margin-top:6px; display:flex; gap:8px;">
            <button class="btn-small" onclick="copyExtractedText()">üìã Copy</button>
            <button class="btn-small" onclick="downloadExtractedText()">‚Üì Save .txt</button>
          </div>
        </div>
      </div>

      <!-- PDF info sub-panel -->
      <div class="tool-subpanel" id="subInfo">
        <button class="btn-small primary-teal" onclick="showPdfInfo()" style="margin-bottom:10px;">Show Info</button>
        <div id="pdfInfoOutput" style="font-size:13px; color:var(--ink); line-height:1.7; display:none;"></div>
      </div>
    </div>

    <!-- PDF Merge Section -->
    <div class="merge-section">
      <div class="merge-title">üìé Merge PDFs</div>
      <div class="merge-drop" id="mergeDropZone" onclick="document.getElementById('mergeInput').click()">
        Drop multiple PDFs here to merge them
      </div>
      <input type="file" id="mergeInput" accept=".pdf,application/pdf" multiple style="display:none">
      <div class="merge-file-list" id="mergeFileList" style="display:none"></div>
      <div id="mergeActions" style="display:none; margin-top:10px; display:none; flex-direction:column; gap:8px;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label style="display:flex; align-items:center; gap:7px; cursor:pointer; font-size:13px; color:var(--ink);">
            <input type="checkbox" id="mergePasswordEnabled" onchange="toggleMergePasswordField()" style="accent-color:var(--teal); width:14px; height:14px;">
            üîí Password protect
          </label>
          <div id="mergePasswordFieldWrap" style="display:none; flex:1;">
            <div class="pw-field" style="margin:0;">
              <input type="password" id="mergePasswordInput" placeholder="Password‚Ä¶">
              <button class="pw-eye" onclick="toggleMergePwEye()" id="mergePwEyeBtn">üëÅ</button>
            </div>
          </div>
        </div>
        <button class="btn-convert btn-teal" id="mergeBtn" onclick="mergePDFs()" style="padding:11px 20px; font-size:14px;">
          ‚ú¶ Merge & Download
        </button>
        <div class="progress-wrap pdf-panel" id="mergeProgress" style="display:none;">
          <div class="progress-bar-bg"><div class="progress-bar-fill" id="mergeProgressBar"></div></div>
          <div class="progress-text" id="mergeProgressText">Merging...</div>
        </div>
        <div class="error-msg" id="mergeError"></div>
      </div>
    </div>
  </div>

</div>

<!-- ===== Crop Modal ===== -->
<div class="modal-overlay" id="cropModal">
  <div class="modal-box" style="max-width:600px;">
    <button class="modal-close" onclick="closeCropModal()">‚úï</button>
    <div class="modal-title">‚úÇ Crop Image</div>
    <div id="cropContainer">
      <img id="cropImg" src="" alt="Crop preview">
      <div id="cropSelection"></div>
    </div>
    <div style="font-size:11px; color:var(--muted); margin-bottom:12px; text-align:center;">
      Drag to select crop area ¬∑ <span id="cropCoords">No selection</span>
    </div>
    <div class="crop-actions">
      <button class="btn-small" onclick="resetCrop()">‚Ü∫ Reset</button>
      <button class="btn-small primary-amber" onclick="applyCrop()">‚úì Apply Crop</button>
    </div>
  </div>
</div>

<!-- ===== Resize Modal ===== -->
<div class="modal-overlay" id="resizeModal">
  <div class="modal-box" style="max-width:400px;">
    <button class="modal-close" onclick="closeResizeModal()">‚úï</button>
    <div class="modal-title">‚á≤ Resize Image</div>
    <div style="font-size:13px; color:var(--muted); margin-bottom:16px;" id="resizeOrigSize"></div>
    <div class="resize-row">
      <div>
        <div class="opt-label">Width (px)</div>
        <input type="number" id="resizeW" min="1" oninput="onResizeW()">
      </div>
      <div class="resize-sep" style="margin-top:20px;">√ó</div>
      <div>
        <div class="opt-label">Height (px)</div>
        <input type="number" id="resizeH" min="1" oninput="onResizeH()">
      </div>
      <div style="margin-top:20px;">
        <button class="resize-lock locked" id="aspectLockBtn" onclick="toggleAspectLock()" title="Lock aspect ratio">üîó</button>
      </div>
    </div>
    <div style="margin-top:16px;">
      <div class="opt-label">Output Format</div>
      <select id="resizeFmt" style="width:100%; margin-top:6px;">
        <option value="image/jpeg">JPEG</option>
        <option value="image/png">PNG</option>
        <option value="image/webp">WEBP</option>
      </select>
    </div>
    <div style="margin-top:16px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn-small" onclick="closeResizeModal()">Cancel</button>
      <button class="btn-small primary-amber" onclick="applyResize()">‚úì Apply Resize</button>
    </div>
  </div>
</div>

<!-- ===== Toast Container ===== -->
<div id="toastContainer"></div>

<!-- ===== Preview Modal ===== -->
<div class="modal-overlay" id="previewModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closePreviewModal()">‚úï</button>
    <div class="modal-title" style="font-size:18px; margin-bottom:14px;" id="previewTitle">Preview</div>
    <img id="previewImg" src="" alt="Preview">
    <div class="preview-nav">
      <button onclick="prevPreview()">‚Üê Prev</button>
      <span class="preview-counter" id="previewCounter"></span>
      <button onclick="nextPreview()">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- ===== Shortcuts FAB ===== -->
<button class="shortcuts-fab" onclick="toggleShortcuts()" title="Keyboard Shortcuts">‚å®</button>
<div class="shortcuts-panel" id="shortcutsPanel">
  <h4>Keyboard Shortcuts</h4>
  <div class="shortcut-row"><span>Open image files</span><span class="shortcut-key">I</span></div>
  <div class="shortcut-row"><span>Open PDF file</span><span class="shortcut-key">P</span></div>
  <div class="shortcut-row"><span>Convert images ‚Üí PDF</span><span class="shortcut-key">Enter</span></div>
  <div class="shortcut-row"><span>Clear images</span><span class="shortcut-key">Escape</span></div>
  <div class="shortcut-row"><span>Toggle dark mode</span><span class="shortcut-key">D</span></div>
  <div class="shortcut-row"><span>Preview image</span><span class="shortcut-key">Space</span></div>
  <div class="shortcut-row"><span>This panel</span><span class="shortcut-key">?</span></div>
</div>

<!-- ===== Auth Modal ===== -->
<div class="modal-overlay" id="authModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeAuthModal()">‚úï</button>
    <div class="auth-logo-wrap">
      <svg viewBox="0 0 44 44" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M22 22 C18 16, 8 10, 4 6 C2 4, 1 8, 3 12 C6 18, 14 20, 22 22Z" fill="#d4820a" opacity="0.9"/>
        <path d="M22 22 C16 24, 6 26, 3 32 C1 36, 4 40, 8 38 C14 34, 18 28, 22 22Z" fill="#f59e0b" opacity="0.75"/>
        <path d="M22 22 C26 16, 36 10, 40 6 C42 4, 43 8, 41 12 C38 18, 30 20, 22 22Z" fill="#0d7377" opacity="0.9"/>
        <path d="M22 22 C28 24, 38 26, 41 32 C43 36, 40 40, 36 38 C30 34, 26 28, 22 22Z" fill="#14a0a5" opacity="0.75"/>
        <ellipse cx="22" cy="22" rx="2" ry="9" fill="#1a1814"/>
      </svg>
    </div>
    <div class="auth-modal-title">Welcome to Morpho</div>
    <div class="auth-modal-sub">Sign in to sync your preferences<br>and access your history</div>

    <button class="btn-google-large" onclick="signInWithGoogle()">
      <svg width="20" height="20" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>

    <div class="auth-divider">or</div>
    <button class="auth-skip" onclick="closeAuthModal()">Continue without signing in</button>
  </div>
</div>

<!-- ===== Firebase SDK ===== -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
    from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';


   const firebaseConfig = {
    apiKey: "AIzaSyBr5LtEwkHDau2oUcSK0czVZH76qjdM6-8",
    authDomain: "ap-cont.firebaseapp.com",
    databaseURL: "https://ap-cont-default-rtdb.firebaseio.com",
    projectId: "ap-cont",
    storageBucket: "ap-cont.appspot.com",
    messagingSenderId: "325531671266",
    appId: "1:325531671266:web:9a0ffa629fc2d730c89cbb",
    measurementId: "G-BK71M75BK3"
  };
  // ============================================

  const app      = initializeApp(firebaseConfig);
  const auth     = getAuth(app);
  const provider = new GoogleAuthProvider();

  // Expose to global scope so onclick handlers can call them
  window._firebaseAuth     = auth;
  window._googleProvider   = provider;
  window._firebaseSignIn   = signInWithPopup;
  window._firebaseSignOut  = signOut;

  // Auth state listener
  onAuthStateChanged(auth, user => {
    const btnSignIn = document.getElementById('btnSignIn');
    const userInfo  = document.getElementById('userInfo');
    if (user) {
      // Logged in
      btnSignIn.style.display = 'none';
      userInfo.style.display  = 'flex';
      document.getElementById('userAvatar').src = user.photoURL || '';
      document.getElementById('userName').textContent = user.displayName || user.email;
      if (typeof showToast === 'function') showToast('üëã Welcome, ' + (user.displayName || 'User') + '!', 'success');
    } else {
      // Logged out
      btnSignIn.style.display = 'flex';
      userInfo.style.display  = 'none';
    }
  });
</script>

<!-- Load libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="module">
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.mjs';
window._pdfjs = pdfjsLib;
</script>
<script>
// ==========================================
// IMAGE ‚Üí PDF
// ==========================================
let imgFiles = [];
let imgPdfBlob = null;

const imgDropZone = document.getElementById('imgDropZone');
const imgInput = document.getElementById('imgInput');
const imgFileList = document.getElementById('imgFileList');
const imgSortNote = document.getElementById('imgSortNote');
const imgOptions = document.getElementById('imgOptions');
const imgConvertBtn = document.getElementById('imgConvertBtn');
const imgProgress = document.getElementById('imgProgress');
const imgProgressBar = document.getElementById('imgProgressBar');
const imgProgressText = document.getElementById('imgProgressText');
const imgResults = document.getElementById('imgResults');
const imgError = document.getElementById('imgError');

// Drag & Drop
imgDropZone.addEventListener('dragover', e => { e.preventDefault(); imgDropZone.classList.add('drag-over'); });
imgDropZone.addEventListener('dragleave', () => imgDropZone.classList.remove('drag-over'));
imgDropZone.addEventListener('drop', e => {
  e.preventDefault(); imgDropZone.classList.remove('drag-over');
  addImageFiles([...e.dataTransfer.files]);
});
imgInput.addEventListener('change', () => addImageFiles([...imgInput.files]));

function addImageFiles(files) {
  const imageFiles = files.filter(f => f.type.startsWith('image/'));
  imgFiles.push(...imageFiles);
  renderImgFileList();
}

function renderImgFileList() {
  imgFileList.innerHTML = '';
  if (imgFiles.length === 0) {
    imgFileList.style.display = 'none';
    imgSortNote.style.display = 'none';
    imgOptions.style.display = 'none';
    document.getElementById('imgOptions2').style.display = 'none';
    document.getElementById('imgPasswordRow').style.display = 'none';
    document.getElementById('imgEditSection').style.display = 'none';
    imgConvertBtn.disabled = true;
    return;
  }
  imgFileList.style.display = 'flex';
  imgSortNote.style.display = 'block';
  imgOptions.style.display = 'flex';
  document.getElementById('imgOptions2').style.display = 'flex';
  document.getElementById('imgPasswordRow').style.display = 'flex';
  document.getElementById('imgEditSection').style.display = 'block';
  imgConvertBtn.disabled = false;

  let dragSrcIdx = null;

  imgFiles.forEach((file, i) => {
    const item = document.createElement('div');
    item.className = 'file-item';
    item.draggable = true;
    item.dataset.idx = i;

    const url = URL.createObjectURL(file);
    const thumb = document.createElement('img');
    thumb.className = 'file-thumb';
    thumb.src = url;
    thumb.onload = () => URL.revokeObjectURL(url);

    item.innerHTML = `
      <div class="file-info">
        <div class="file-name">${i+1}. ${file.name}</div>
        <div class="file-size">${(file.size/1024).toFixed(1)} KB</div>
      </div>
      <div class="file-actions">
        <button class="file-action-btn" title="Preview" onclick="openPreview(${i})">üëÅ</button>
        <button class="file-action-btn" title="Crop" onclick="openCropModal(${i})">‚úÇ</button>
        <button class="file-action-btn" title="Resize" onclick="openResizeModal(${i})">‚á≤</button>
        <button class="file-remove" onclick="removeImgFile(${i})">√ó</button>
      </div>
    `;
    item.insertBefore(thumb, item.firstChild);

    // Drag reorder events
    item.addEventListener('dragstart', e => {
      dragSrcIdx = i;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('drag-target'));
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('drag-target'));
      item.classList.add('drag-target');
    });
    item.addEventListener('drop', e => {
      e.preventDefault();
      if (dragSrcIdx !== null && dragSrcIdx !== i) {
        const moved = imgFiles.splice(dragSrcIdx, 1)[0];
        imgFiles.splice(i, 0, moved);
        renderImgFileList();
      }
    });

    imgFileList.appendChild(item);
  });
}

window.removeImgFile = function(i) {
  imgFiles.splice(i, 1);
  renderImgFileList();
};

window.resetImg = function() {
  imgFiles = []; imgPdfBlob = null;
  imgResults.style.display = 'none';
  imgError.style.display = 'none';
  imgInput.value = '';
  renderImgFileList();
};

window.convertImagesToPDF = async function() {
  if (!imgFiles.length) return;
  imgError.style.display = 'none';
  imgResults.style.display = 'none';
  imgProgress.style.display = 'block';
  imgConvertBtn.disabled = true;

  try {
    // Wait for jsPDF to be available
    let attempts = 0;
    while (!window.jspdf && attempts < 20) {
      await new Promise(r => setTimeout(r, 200));
      attempts++;
    }
    if (!window.jspdf) throw new Error('jsPDF library failed to load');

    const { jsPDF } = window.jspdf;
    const pageSize = document.getElementById('imgPageSize').value;
    const orientation = document.getElementById('imgOrientation').value;
    const fitMode = document.getElementById('imgFit').value;
    const quality = parseFloat(document.getElementById('imgQuality').value);
    const pageNumPos = document.getElementById('imgPageNumbers').value;

    // Page dimensions in mm
    const pageSizes = {
      a4: [210, 297],
      letter: [215.9, 279.4],
    };

    let pdf = null;

    for (let i = 0; i < imgFiles.length; i++) {
      imgProgressBar.style.width = Math.round((i / imgFiles.length) * 90) + '%';
      imgProgressText.textContent = `Adding image ${i+1} of ${imgFiles.length}...`;

      const file = imgFiles[i];
      // Apply quality compression + image adjustments + watermark via canvas
      const imgData = await (window._fileToDataURLForConvert || fileToDataURLWithQuality)(file, quality);
      const dims = await getImageDimensions(imgData);

      let pw, ph, orient;

      if (pageSize === 'fit') {
        pw = dims.w * 0.264583; // px to mm at 96dpi
        ph = dims.h * 0.264583;
        orient = pw > ph ? 'landscape' : 'portrait';
      } else {
        [pw, ph] = pageSizes[pageSize];
        orient = orientation === 'auto'
          ? (dims.w > dims.h ? 'landscape' : 'portrait')
          : orientation;
        if (orient === 'landscape') [pw, ph] = [ph, pw];
      }

      if (!pdf) {
        pdf = new jsPDF({ orientation: orient, unit: 'mm', format: pageSize === 'fit' ? [pw, ph] : pageSize });
      } else {
        pdf.addPage(pageSize === 'fit' ? [pw, ph] : pageSize, orient);
      }

      // Calculate image position and size on page
      let iw, ih, ix, iy;
      const margin = 8;
      const aw = pw - margin*2, ah = ph - margin*2;

      if (fitMode === 'fill') {
        iw = pw; ih = ph; ix = 0; iy = 0;
      } else if (fitMode === 'original') {
        iw = Math.min(dims.w * 0.264583, pw);
        ih = (iw / dims.w) * dims.h;
        ix = (pw - iw) / 2;
        iy = (ph - ih) / 2;
      } else {
        // contain
        const scale = Math.min(aw / dims.w, ah / dims.h);
        iw = dims.w * scale;
        ih = dims.h * scale;
        ix = (pw - iw) / 2;
        iy = (ph - ih) / 2;
      }

      const fmt = file.type === 'image/png' && quality === 1 ? 'PNG' : 'JPEG';
      pdf.addImage(imgData, fmt, ix, iy, iw, ih);

      // Add page number
      if (pageNumPos !== 'none') {
        pdf.setFontSize(9);
        pdf.setTextColor(150, 150, 150);
        const pageLabel = `${i+1} / ${imgFiles.length}`;
        const textW = pdf.getTextWidth(pageLabel);
        let tx, ty;
        if (pageNumPos === 'bottom-center') { tx = pw/2 - textW/2; ty = ph - 5; }
        else if (pageNumPos === 'bottom-right') { tx = pw - margin - textW; ty = ph - 5; }
        else if (pageNumPos === 'top-center') { tx = pw/2 - textW/2; ty = 7; }
        pdf.text(pageLabel, tx, ty);
      }
    }

    imgProgressBar.style.width = '100%';
    imgProgressText.textContent = 'Generating PDF...';

    const pwEnabled = document.getElementById('imgPasswordEnabled').checked;
    const pwValue = pwEnabled ? document.getElementById('imgPasswordInput').value : null;

    imgPdfBlob = pwValue
      ? pdf.output('blob', { userPassword: pwValue, ownerPassword: pwValue + '_o', userPermissions: ['print', 'copy'] })
      : pdf.output('blob');
    window.imgPdfBlob = imgPdfBlob; // Expose globally for Firebase upload
    const url = URL.createObjectURL(imgPdfBlob);

    // Download button
    const dlBtn = document.getElementById('imgDownloadBtn');
    dlBtn.onclick = () => {
      const customName = (document.getElementById('pdfOutputName').value.trim() || 'morpho-converted').replace(/\.pdf$/i, '');
      const a = document.createElement('a');
      a.href = url;
      a.download = customName + '.pdf';
      a.click();
    };

    setTimeout(() => {
      imgProgress.style.display = 'none';
      imgResults.style.display = 'block';
      imgConvertBtn.disabled = false;
    }, 400);

  } catch(e) {
    imgProgress.style.display = 'none';
    imgConvertBtn.disabled = false;
    imgError.textContent = '‚ö† ' + (e.message || 'Conversion failed');
    imgError.style.display = 'block';
    console.error(e);
  }
};

function fileToDataURL(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function fileToDataURLWithQuality(file, quality) {
  const dataURL = await fileToDataURL(file);
  if (quality >= 1 && file.type === 'image/png') return dataURL;
  // Compress via canvas
  const img = await new Promise(res => {
    const i = new Image(); i.onload = () => res(i); i.src = dataURL;
  });
  const canvas = document.createElement('canvas');
  canvas.width = img.width; canvas.height = img.height;
  canvas.getContext('2d').drawImage(img, 0, 0);
  return canvas.toDataURL('image/jpeg', quality);
}

// Dark mode toggle
function toggleDarkMode() {
  const body = document.body;
  const isDark = body.classList.toggle('dark-mode');
  document.getElementById('darkIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = isDark ? 'Light' : 'Dark';
  localStorage.setItem('morpho-dark', isDark ? '1' : '0');
}

// Restore dark mode preference
if (localStorage.getItem('morpho-dark') === '1') toggleDarkMode();

function getImageDimensions(dataURL) {
  return new Promise((res) => {
    const img = new Image();
    img.onload = () => res({ w: img.width, h: img.height });
    img.src = dataURL;
  });
}

// ---- Morpho Branding ----
// Draw Morpho butterfly logo onto a canvas context at (cx,cy) with given size
function drawMorphoLogoOnCanvas(ctx, cx, cy, size) {
  const s = size / 44; // scale factor (logo designed at 44px)
  ctx.save();
  ctx.translate(cx - 22*s, cy - 22*s);
  ctx.scale(s, s);

  // Left wing top ‚Äî amber
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(18, 16, 8, 10, 4, 6);
  ctx.bezierCurveTo(2, 4, 1, 8, 3, 12);
  ctx.bezierCurveTo(6, 18, 14, 20, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(212,130,10,0.92)';
  ctx.fill();

  // Left wing bottom ‚Äî amber light
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(16, 24, 6, 26, 3, 32);
  ctx.bezierCurveTo(1, 36, 4, 40, 8, 38);
  ctx.bezierCurveTo(14, 34, 18, 28, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(245,158,11,0.75)';
  ctx.fill();

  // Right wing top ‚Äî teal
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(26, 16, 36, 10, 40, 6);
  ctx.bezierCurveTo(42, 4, 43, 8, 41, 12);
  ctx.bezierCurveTo(38, 18, 30, 20, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(13,115,119,0.92)';
  ctx.fill();

  // Right wing bottom ‚Äî teal light
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(28, 24, 38, 26, 41, 32);
  ctx.bezierCurveTo(43, 36, 40, 40, 36, 38);
  ctx.bezierCurveTo(30, 34, 26, 28, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(20,160,165,0.75)';
  ctx.fill();

  // Shimmer dots
  [[11,14,2,'rgba(255,255,255,0.4)'],[33,14,2,'rgba(255,255,255,0.4)'],
   [9,32,1.5,'rgba(255,255,255,0.3)'],[35,32,1.5,'rgba(255,255,255,0.3)']].forEach(([x,y,r,c]) => {
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle = c; ctx.fill();
  });

  // Body
  ctx.beginPath();
  ctx.ellipse(22, 22, 2, 9, 0, 0, Math.PI*2);
  ctx.fillStyle = '#1a1814';
  ctx.fill();

  // Antennae
  ctx.strokeStyle = '#1a1814';
  ctx.lineWidth = 1;
  ctx.lineCap = 'round';
  ctx.beginPath(); ctx.moveTo(21,14); ctx.quadraticCurveTo(18,8,16,5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(23,14); ctx.quadraticCurveTo(26,8,28,5); ctx.stroke();

  // Antenna tips
  ctx.beginPath(); ctx.arc(16,5,1.2,0,Math.PI*2); ctx.fillStyle='#d4820a'; ctx.fill();
  ctx.beginPath(); ctx.arc(28,5,1.2,0,Math.PI*2); ctx.fillStyle='#0d7377'; ctx.fill();

  ctx.restore();
}

// Add Morpho branding as last page ‚Äî slim 1.5cm strip (210mm √ó 15mm)
function addMorphoBrandingPageToPDF(pdf) {
  const pw = 210;   // mm ‚Äî A4 width
  const ph = 15;    // mm ‚Äî 1.5cm tall strip

  pdf.addPage([pw, ph], 'portrait');

  // Cream background
  pdf.setFillColor(250, 248, 243);
  pdf.rect(0, 0, pw, ph, 'F');

  // Top & bottom border lines
  pdf.setDrawColor(224, 219, 208);
  pdf.setLineWidth(0.2);
  pdf.line(0, 0.1, pw, 0.1);
  pdf.line(0, ph - 0.1, pw, ph - 0.1);

  // Butterfly logo ‚Äî render at 200px canvas, place at 7.5mm tall centred = 7.5mm
  const logoMM = 8; // logo height/width in mm
  const bc = document.createElement('canvas');
  bc.width = 160; bc.height = 160;
  const bctx = bc.getContext('2d');
  drawMorphoLogoOnCanvas(bctx, 80, 80, 120);
  const bimg = bc.toDataURL('image/png');

  // Lay out: [logo] [Morpho] [¬∑] [Image ‚Üî PDF Converter] ‚Äî all horizontally centred
  // Calculate total content width to centre it
  // Logo: logoMM wide, gap 2mm, "Morpho" ~18mm, gap 2mm, dot 2mm, gap 2mm, tagline ~38mm
  const contentW = logoMM + 2 + 18 + 2 + 2 + 2 + 38;
  let cx = (pw - contentW) / 2;
  const midY = ph / 2;

  // Logo image
  pdf.addImage(bimg, 'PNG', cx, midY - logoMM/2, logoMM, logoMM);
  cx += logoMM + 2.5;

  // "Morpho" bold
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(9);
  pdf.setTextColor(26, 24, 20);
  pdf.text('Morpho', cx, midY + 1.5);
  cx += 19;

  // Separator dot
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(180, 175, 165);
  pdf.text('\u00B7', cx, midY + 1.5);
  cx += 3.5;

  // Tagline
  pdf.setFontSize(7.5);
  pdf.setTextColor(138, 132, 120);
  pdf.text('Image \u2194 PDF Converter', cx, midY + 1.5);
}

// Add Morpho watermark overlay onto a rendered page canvas (bottom-right corner)
function addMorphoWatermarkToCanvas(canvas) {
  const ctx = canvas.getContext('2d');
  const pad = 18;
  const logoSize = 32;
  const textH = 11;
  const totalW = logoSize + 6 + 60;
  const totalH = Math.max(logoSize, textH * 2 + 4);
  const x = canvas.width - pad - totalW;
  const y = canvas.height - pad - totalH;

  // Background pill
  const pillW = totalW + 16, pillH = totalH + 10;
  const pillX = canvas.width - pad - pillW;
  const pillY = canvas.height - pad - pillH;
  const r = 10;
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(pillX+r, pillY);
  ctx.lineTo(pillX+pillW-r, pillY);
  ctx.quadraticCurveTo(pillX+pillW, pillY, pillX+pillW, pillY+r);
  ctx.lineTo(pillX+pillW, pillY+pillH-r);
  ctx.quadraticCurveTo(pillX+pillW, pillY+pillH, pillX+pillW-r, pillY+pillH);
  ctx.lineTo(pillX+r, pillY+pillH);
  ctx.quadraticCurveTo(pillX, pillY+pillH, pillX, pillY+pillH-r);
  ctx.lineTo(pillX, pillY+r);
  ctx.quadraticCurveTo(pillX, pillY, pillX+r, pillY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(250,248,243,0.88)';
  ctx.shadowColor = 'rgba(0,0,0,0.12)';
  ctx.shadowBlur = 12;
  ctx.fill();
  ctx.restore();

  // Butterfly logo
  const lx = pillX + 10;
  const ly = pillY + pillH/2;
  drawMorphoLogoOnCanvas(ctx, lx + logoSize/2, ly, logoSize);

  // "Morpho" text
  ctx.save();
  const tx = lx + logoSize + 8;
  const ty = pillY + pillH/2 - 4;
  ctx.font = `bold ${Math.round(canvas.width * 0.012)}px sans-serif`;
  const fs = Math.max(14, Math.min(22, Math.round(canvas.width * 0.014)));
  ctx.font = `bold ${fs}px Georgia, serif`;
  ctx.fillStyle = '#1a1814';
  ctx.fillText('Morpho', tx, ty + fs * 0.75);

  const subFs = Math.max(9, Math.round(fs * 0.6));
  ctx.font = `${subFs}px sans-serif`;
  ctx.fillStyle = '#8a8478';
  ctx.fillText('Image \u2194 PDF', tx, ty + fs * 0.75 + subFs + 3);
  ctx.restore();
}


// ==========================================
// PDF ‚Üí Images
// ==========================================
let pdfRenderedPages = []; // {blob, pageNum}

const pdfDropZone = document.getElementById('pdfDropZone');
const pdfInput = document.getElementById('pdfInput');
const pdfOptions = document.getElementById('pdfOptions');
const pdfConvertBtn = document.getElementById('pdfConvertBtn');
const pdfProgress = document.getElementById('pdfProgress');
const pdfProgressBar = document.getElementById('pdfProgressBar');
const pdfProgressText = document.getElementById('pdfProgressText');
const pdfResults = document.getElementById('pdfResults');
const pdfResultGrid = document.getElementById('pdfResultGrid');
const pdfError = document.getElementById('pdfError');
let pdfFile = null;

pdfDropZone.addEventListener('dragover', e => { e.preventDefault(); pdfDropZone.classList.add('drag-over'); });
pdfDropZone.addEventListener('dragleave', () => pdfDropZone.classList.remove('drag-over'));
pdfDropZone.addEventListener('drop', e => {
  e.preventDefault(); pdfDropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && (file.type === 'application/pdf' || file.name.endsWith('.pdf'))) setPDFFile(file);
});
pdfInput.addEventListener('change', () => {
  if (pdfInput.files[0]) setPDFFile(pdfInput.files[0]);
});

document.getElementById('pdfPages').addEventListener('change', function() {
  document.getElementById('pdfRangeWrap').style.display = this.value === 'range' ? 'block' : 'none';
});

function setPDFFile(file) {
  pdfFile = file;
  pdfDropZone.querySelector('.dz-title').textContent = file.name;
  pdfDropZone.querySelector('.dz-sub').textContent = (file.size / 1024).toFixed(1) + ' KB';
  pdfOptions.style.display = 'flex';
  pdfConvertBtn.disabled = false;
  pdfResults.style.display = 'none';
  pdfRenderedPages = [];
  pdfError.style.display = 'none';
  document.getElementById('pdfToolsSection').style.display = 'block';
  showToast('üìÑ PDF loaded: ' + file.name, 'info');
}

window.resetPDF = function() {
  pdfFile = null; pdfRenderedPages = [];
  pdfDropZone.querySelector('.dz-title').textContent = 'Drop a PDF here';
  pdfDropZone.querySelector('.dz-sub').textContent = 'One PDF file';
  pdfOptions.style.display = 'none';
  pdfConvertBtn.disabled = true;
  pdfResults.style.display = 'none';
  pdfResultGrid.innerHTML = '';
  pdfError.style.display = 'none';
  pdfInput.value = '';
  document.getElementById('pdfToolsSection').style.display = 'none';
  // hide all subpanels
  document.querySelectorAll('.tool-subpanel').forEach(p => p.classList.remove('show'));
  document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('active-tool'));
};

window.convertPDFToImages = async function() {
  if (!pdfFile) return;
  pdfError.style.display = 'none';
  pdfResults.style.display = 'none';
  pdfResultGrid.innerHTML = '';
  pdfProgress.style.display = 'block';
  pdfConvertBtn.disabled = true;
  pdfRenderedPages = [];

  try {
    // Wait for PDF.js
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) {
      await new Promise(r => setTimeout(r, 200));
      attempts++;
    }
    if (!window._pdfjs) throw new Error('PDF.js not loaded yet, try again');
    const pdfjsLib = window._pdfjs;

    const fmt = document.getElementById('pdfFormat').value;
    const scale = parseFloat(document.getElementById('pdfQuality').value);
    const pagesMode = document.getElementById('pdfPages').value;

    const arrayBuffer = await pdfFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const total = pdf.numPages;

    // Determine page numbers
    let pageNums = [];
    if (pagesMode === 'first') {
      pageNums = [1];
    } else if (pagesMode === 'range') {
      const rangeStr = document.getElementById('pdfRangeInput').value;
      pageNums = parsePageRange(rangeStr, total);
      if (!pageNums.length) throw new Error('Invalid page range');
    } else {
      pageNums = Array.from({ length: total }, (_, i) => i + 1);
    }

    for (let pi = 0; pi < pageNums.length; pi++) {
      const pageNum = pageNums[pi];
      pdfProgressBar.style.width = Math.round((pi / pageNums.length) * 95) + '%';
      pdfProgressText.textContent = `Rendering page ${pageNum} of ${total}...`;

      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      // Add Morpho branding watermark
      addMorphoWatermarkToCanvas(canvas);

      const mimeType = fmt === 'png' ? 'image/png' : fmt === 'webp' ? 'image/webp' : 'image/jpeg';
      const quality = fmt === 'png' ? 1 : 0.92;

      const blob = await new Promise(res => canvas.toBlob(res, mimeType, quality));
      const url = URL.createObjectURL(blob);
      pdfRenderedPages.push({ blob, url, pageNum, fmt });

      // Add to grid
      const wrap = document.createElement('div');
      wrap.className = 'result-thumb-wrap';
      wrap.title = `Click to download page ${pageNum}`;
      wrap.onclick = () => downloadBlob(blob, `page-${pageNum}.${fmt}`);
      const img = document.createElement('img');
      img.src = url;
      const label = document.createElement('div');
      label.className = 'result-page-label';
      label.textContent = 'P' + pageNum;
      wrap.appendChild(img);
      wrap.appendChild(label);
      pdfResultGrid.appendChild(wrap);
    }

    pdfProgressBar.style.width = '100%';

    // Download All button
    const dlAllBtn = document.getElementById('pdfDownloadAllBtn');
    if (pdfRenderedPages.length === 1) {
      dlAllBtn.textContent = '‚Üì Download Image';
      dlAllBtn.onclick = () => downloadBlob(pdfRenderedPages[0].blob, `page-${pdfRenderedPages[0].pageNum}.${pdfRenderedPages[0].fmt}`);
    } else {
      dlAllBtn.textContent = `‚Üì Download All (${pdfRenderedPages.length}) as ZIP`;
      dlAllBtn.onclick = downloadAllImages;
    }

    setTimeout(() => {
      pdfProgress.style.display = 'none';
      pdfResults.style.display = 'block';
      pdfConvertBtn.disabled = false;
    }, 400);

  } catch(e) {
    pdfProgress.style.display = 'none';
    pdfConvertBtn.disabled = false;
    pdfError.textContent = '‚ö† ' + (e.message || 'Conversion failed');
    pdfError.style.display = 'block';
    console.error(e);
  }
};

async function downloadAllImages() {
  const btn = document.getElementById('pdfDownloadAllBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Zipping...';

  // Wait for JSZip
  let attempts = 0;
  while (!window.JSZip && attempts < 20) {
    await new Promise(r => setTimeout(r, 200));
    attempts++;
  }

  const zip = new window.JSZip();
  for (const p of pdfRenderedPages) {
    zip.file(`page-${p.pageNum}.${p.fmt}`, p.blob);
  }
  const zipBlob = await zip.generateAsync({ type: 'blob' });
  downloadBlob(zipBlob, 'pdf-pages.zip');
  btn.disabled = false;
  btn.textContent = `‚Üì Download All (${pdfRenderedPages.length}) as ZIP`;
}

function downloadBlob(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function parsePageRange(str, total) {
  const pages = new Set();
  str.split(',').forEach(part => {
    part = part.trim();
    if (part.includes('-')) {
      let [a, b] = part.split('-').map(Number);
      a = Math.max(1, a); b = Math.min(total, b);
      for (let i = a; i <= b; i++) pages.add(i);
    } else {
      const n = parseInt(part);
      if (!isNaN(n) && n >= 1 && n <= total) pages.add(n);
    }
  });
  return [...pages].sort((a, b) => a - b);
}

// ==========================================
// PASSWORD PROTECTION
// ==========================================
function togglePasswordField() {
  const enabled = document.getElementById('imgPasswordEnabled').checked;
  document.getElementById('imgPasswordFieldWrap').style.display = enabled ? 'flex' : 'none';
}
function toggleMergePasswordField() {
  const enabled = document.getElementById('mergePasswordEnabled').checked;
  document.getElementById('mergePasswordFieldWrap').style.display = enabled ? 'flex' : 'none';
}
function togglePwEye() {
  const inp = document.getElementById('imgPasswordInput');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  document.getElementById('pwEyeBtn').textContent = inp.type === 'password' ? 'üëÅ' : 'üôà';
}
function toggleMergePwEye() {
  const inp = document.getElementById('mergePasswordInput');
  inp.type = inp.type === 'password' ? 'text' : 'password';
  document.getElementById('mergePwEyeBtn').textContent = inp.type === 'password' ? 'üëÅ' : 'üôà';
}
function updatePwStrength() {
  const pw = document.getElementById('imgPasswordInput').value;
  const el = document.getElementById('pwStrength');
  if (!pw) { el.className = 'pw-strength'; return; }
  const strong = pw.length >= 12 && /[A-Z]/.test(pw) && /[0-9]/.test(pw) && /[^A-Za-z0-9]/.test(pw);
  const medium = pw.length >= 8 && (/[A-Z]/.test(pw) || /[0-9]/.test(pw));
  el.className = 'pw-strength ' + (strong ? 'strong' : medium ? 'medium' : 'weak');
}

// Apply PDF password via encryption (jsPDF supports userPassword / ownerPassword)
function getPdfWithPassword(pdf, password) {
  if (!password) return pdf.output('blob');
  // jsPDF supports encryption options
  return pdf.output('blob', {
    userPassword: password,
    ownerPassword: password + '_owner',
    userPermissions: ['print', 'copy']
  });
}

// ==========================================
// IMAGE CROP
// ==========================================
let cropFileIdx = null;
let cropStart = null, cropEnd = null, cropDragging = false;
let cropImgNaturalW = 0, cropImgNaturalH = 0;

function openCropModal(idx) {
  cropFileIdx = idx;
  cropStart = null; cropEnd = null;
  const modal = document.getElementById('cropModal');
  const img = document.getElementById('cropImg');
  const sel = document.getElementById('cropSelection');
  sel.style.display = 'none';
  document.getElementById('cropCoords').textContent = 'No selection';

  const url = URL.createObjectURL(imgFiles[idx]);
  img.onload = () => {
    cropImgNaturalW = img.naturalWidth;
    cropImgNaturalH = img.naturalHeight;
    URL.revokeObjectURL(url);
  };
  img.src = url;
  modal.classList.add('open');
  setupCropEvents();
}

function closeCropModal() {
  document.getElementById('cropModal').classList.remove('open');
}

function setupCropEvents() {
  const container = document.getElementById('cropContainer');
  const sel = document.getElementById('cropSelection');

  container.onmousedown = e => {
    const rect = container.getBoundingClientRect();
    cropStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    cropEnd = { ...cropStart };
    cropDragging = true;
    sel.style.display = 'block';
    updateCropSelection();
  };

  container.onmousemove = e => {
    if (!cropDragging) return;
    const rect = container.getBoundingClientRect();
    cropEnd = {
      x: Math.max(0, Math.min(e.clientX - rect.left, rect.width)),
      y: Math.max(0, Math.min(e.clientY - rect.top, rect.height))
    };
    updateCropSelection();
  };

  container.onmouseup = () => { cropDragging = false; };
}

function updateCropSelection() {
  if (!cropStart || !cropEnd) return;
  const sel = document.getElementById('cropSelection');
  const x = Math.min(cropStart.x, cropEnd.x);
  const y = Math.min(cropStart.y, cropEnd.y);
  const w = Math.abs(cropEnd.x - cropStart.x);
  const h = Math.abs(cropEnd.y - cropStart.y);
  sel.style.left = x + 'px';
  sel.style.top = y + 'px';
  sel.style.width = w + 'px';
  sel.style.height = h + 'px';

  // Show pixel coords
  const img = document.getElementById('cropImg');
  const scaleX = cropImgNaturalW / img.offsetWidth;
  const scaleY = cropImgNaturalH / img.offsetHeight;
  const px = Math.round(x * scaleX), py = Math.round(y * scaleY);
  const pw = Math.round(w * scaleX), ph = Math.round(h * scaleY);
  document.getElementById('cropCoords').textContent = `${px},${py} ¬∑ ${pw}√ó${ph}px`;
}

function resetCrop() {
  cropStart = null; cropEnd = null;
  document.getElementById('cropSelection').style.display = 'none';
  document.getElementById('cropCoords').textContent = 'No selection';
}

async function applyCrop() {
  if (!cropStart || !cropEnd || cropFileIdx === null) { closeCropModal(); return; }

  const img = document.getElementById('cropImg');
  const scaleX = cropImgNaturalW / img.offsetWidth;
  const scaleY = cropImgNaturalH / img.offsetHeight;

  const x = Math.round(Math.min(cropStart.x, cropEnd.x) * scaleX);
  const y = Math.round(Math.min(cropStart.y, cropEnd.y) * scaleY);
  const w = Math.round(Math.abs(cropEnd.x - cropStart.x) * scaleX);
  const h = Math.round(Math.abs(cropEnd.y - cropStart.y) * scaleY);

  if (w < 1 || h < 1) { closeCropModal(); return; }

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');

  // Draw original file to an offscreen image
  const origUrl = URL.createObjectURL(imgFiles[cropFileIdx]);
  const origImg = await new Promise(res => {
    const i = new Image(); i.onload = () => { URL.revokeObjectURL(origUrl); res(i); }; i.src = origUrl;
  });
  ctx.drawImage(origImg, x, y, w, h, 0, 0, w, h);

  // Convert cropped canvas to File
  const blob = await new Promise(res => canvas.toBlob(res, imgFiles[cropFileIdx].type || 'image/jpeg', 0.95));
  const croppedFile = new File([blob], imgFiles[cropFileIdx].name, { type: blob.type });
  imgFiles[cropFileIdx] = croppedFile;
  renderImgFileList();
  closeCropModal();
}

// ==========================================
// IMAGE RESIZE
// ==========================================
let resizeFileIdx = null;
let resizeOrigW = 0, resizeOrigH = 0;
let aspectLocked = true;

function openResizeModal(idx) {
  resizeFileIdx = idx;
  const modal = document.getElementById('resizeModal');
  const file = imgFiles[idx];

  fileToDataURL(file).then(dataURL => {
    const img = new Image();
    img.onload = () => {
      resizeOrigW = img.naturalWidth;
      resizeOrigH = img.naturalHeight;
      document.getElementById('resizeOrigSize').textContent = `Original: ${resizeOrigW} √ó ${resizeOrigH} px`;
      document.getElementById('resizeW').value = resizeOrigW;
      document.getElementById('resizeH').value = resizeOrigH;
    };
    img.src = dataURL;
  });

  modal.classList.add('open');
}

function closeResizeModal() {
  document.getElementById('resizeModal').classList.remove('open');
}

function toggleAspectLock() {
  aspectLocked = !aspectLocked;
  const btn = document.getElementById('aspectLockBtn');
  btn.classList.toggle('locked', aspectLocked);
  btn.textContent = aspectLocked ? 'üîó' : 'üîì';
}

function onResizeW() {
  if (!aspectLocked) return;
  const w = parseInt(document.getElementById('resizeW').value) || 1;
  document.getElementById('resizeH').value = Math.round(w * resizeOrigH / resizeOrigW);
}

function onResizeH() {
  if (!aspectLocked) return;
  const h = parseInt(document.getElementById('resizeH').value) || 1;
  document.getElementById('resizeW').value = Math.round(h * resizeOrigW / resizeOrigH);
}

async function applyResize() {
  if (resizeFileIdx === null) { closeResizeModal(); return; }
  const w = parseInt(document.getElementById('resizeW').value);
  const h = parseInt(document.getElementById('resizeH').value);
  const fmt = document.getElementById('resizeFmt').value;
  if (!w || !h) { closeResizeModal(); return; }

  const origUrl = URL.createObjectURL(imgFiles[resizeFileIdx]);
  const origImg = await new Promise(res => {
    const i = new Image(); i.onload = () => { URL.revokeObjectURL(origUrl); res(i); }; i.src = origUrl;
  });

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  canvas.getContext('2d').drawImage(origImg, 0, 0, w, h);

  const ext = fmt.split('/')[1];
  const blob = await new Promise(res => canvas.toBlob(res, fmt, 0.92));
  const resizedFile = new File([blob], imgFiles[resizeFileIdx].name.replace(/\.[^.]+$/, '') + '.' + ext, { type: fmt });
  imgFiles[resizeFileIdx] = resizedFile;
  renderImgFileList();
  closeResizeModal();
}

// ==========================================
// PDF MERGE
// ==========================================
let mergeFiles = [];

const mergeDropZone = document.getElementById('mergeDropZone');
const mergeInput = document.getElementById('mergeInput');

mergeDropZone.addEventListener('dragover', e => { e.preventDefault(); mergeDropZone.classList.add('drag-over'); });
mergeDropZone.addEventListener('dragleave', () => mergeDropZone.classList.remove('drag-over'));
mergeDropZone.addEventListener('drop', e => {
  e.preventDefault(); mergeDropZone.classList.remove('drag-over');
  addMergeFiles([...e.dataTransfer.files].filter(f => f.type === 'application/pdf' || f.name.endsWith('.pdf')));
});
mergeInput.addEventListener('change', () => {
  addMergeFiles([...mergeInput.files]);
  mergeInput.value = '';
});

function addMergeFiles(files) {
  mergeFiles.push(...files);
  renderMergeList();
}

function renderMergeList() {
  const list = document.getElementById('mergeFileList');
  const actions = document.getElementById('mergeActions');
  if (mergeFiles.length === 0) {
    list.style.display = 'none';
    actions.style.display = 'none';
    return;
  }
  list.style.display = 'flex';
  actions.style.display = 'flex';
  list.innerHTML = '';

  let dragSrcIdx = null;
  mergeFiles.forEach((file, i) => {
    const item = document.createElement('div');
    item.className = 'merge-file-item';
    item.draggable = true;
    item.innerHTML = `
      <span class="merge-file-icon">üìÑ</span>
      <span class="merge-file-name">${i+1}. ${file.name}</span>
      <span class="merge-file-size">${(file.size/1024).toFixed(0)}KB</span>
      <button class="merge-file-remove" onclick="removeMergeFile(${i})">√ó</button>
    `;
    item.addEventListener('dragstart', e => { dragSrcIdx = i; item.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
    item.addEventListener('dragend', () => { item.classList.remove('dragging'); list.querySelectorAll('.merge-file-item').forEach(el => el.classList.remove('drag-target')); });
    item.addEventListener('dragover', e => { e.preventDefault(); list.querySelectorAll('.merge-file-item').forEach(el => el.classList.remove('drag-target')); item.classList.add('drag-target'); });
    item.addEventListener('drop', e => {
      e.preventDefault();
      if (dragSrcIdx !== null && dragSrcIdx !== i) {
        const moved = mergeFiles.splice(dragSrcIdx, 1)[0];
        mergeFiles.splice(i, 0, moved);
        renderMergeList();
      }
    });
    list.appendChild(item);
  });
}

window.removeMergeFile = function(i) {
  mergeFiles.splice(i, 1);
  renderMergeList();
};

window.mergePDFs = async function() {
  if (mergeFiles.length < 2) {
    document.getElementById('mergeError').textContent = '‚ö† Please add at least 2 PDFs to merge.';
    document.getElementById('mergeError').style.display = 'block';
    return;
  }

  document.getElementById('mergeError').style.display = 'none';
  const progressWrap = document.getElementById('mergeProgress');
  const bar = document.getElementById('mergeProgressBar');
  const text = document.getElementById('mergeProgressText');
  progressWrap.style.display = 'block';
  document.getElementById('mergeBtn').disabled = true;

  try {
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    while (!window.jspdf && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }

    const { jsPDF } = window.jspdf;
    const pdfjsLib = window._pdfjs;
    let mergedPdf = null;
    let totalPages = 0;

    for (let fi = 0; fi < mergeFiles.length; fi++) {
      bar.style.width = Math.round((fi / mergeFiles.length) * 90) + '%';
      text.textContent = `Processing ${fi+1}/${mergeFiles.length}: ${mergeFiles[fi].name}`;

      const arrayBuf = await mergeFiles[fi].arrayBuffer();
      const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuf }).promise;

      for (let pi = 1; pi <= pdfDoc.numPages; pi++) {
        const page = await pdfDoc.getPage(pi);
        const vp = page.getViewport({ scale: 2 });
        const canvas = document.createElement('canvas');
        canvas.width = vp.width; canvas.height = vp.height;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;

        // mm dimensions
        const pw = vp.width * 0.264583 / 2;
        const ph = vp.height * 0.264583 / 2;
        const orient = pw > ph ? 'landscape' : 'portrait';

        if (!mergedPdf) {
          mergedPdf = new jsPDF({ orientation: orient, unit: 'mm', format: [pw, ph] });
        } else {
          mergedPdf.addPage([pw, ph], orient);
        }

        const imgData = canvas.toDataURL('image/jpeg', 0.92);
        mergedPdf.addImage(imgData, 'JPEG', 0, 0, pw, ph);
        totalPages++;
      }
    }

    bar.style.width = '100%';
    text.textContent = `Generating merged PDF (${totalPages} pages)...`;

    const password = document.getElementById('mergePasswordEnabled').checked
      ? document.getElementById('mergePasswordInput').value : null;

    const blob = password
      ? mergedPdf.output('blob', { userPassword: password, ownerPassword: password + '_o', userPermissions: ['print'] })
      : mergedPdf.output('blob');

    downloadBlob(blob, 'morpho-merged.pdf');

    setTimeout(() => {
      progressWrap.style.display = 'none';
      document.getElementById('mergeBtn').disabled = false;
    }, 400);

  } catch(e) {
    progressWrap.style.display = 'none';
    document.getElementById('mergeBtn').disabled = false;
    document.getElementById('mergeError').textContent = '‚ö† Merge failed: ' + (e.message || 'Unknown error');
    document.getElementById('mergeError').style.display = 'block';
    console.error(e);
  }
};

// ==========================================
// TOAST NOTIFICATIONS
// ==========================================
function showToast(msg, type = 'info', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  const icons = { success: '‚úì', error: '‚ö†', info: '‚óÜ' };
  toast.innerHTML = `<span>${icons[type] || '‚óÜ'}</span><span>${msg}</span>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = 'toastIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// Override convert functions to show toasts
const _origConvertImg = window.convertImagesToPDF;
window.convertImagesToPDF = async function() {
  try {
    await _origConvertImg();
    showToast('‚úì PDF created successfully!', 'success');
  } catch(e) {
    showToast('‚ö† ' + (e.message || 'Failed'), 'error');
  }
};

// ==========================================
// IMAGE PREVIEW MODAL
// ==========================================
let previewIdx = 0;

function openPreview(idx) {
  previewIdx = idx;
  showPreviewAt(idx);
  document.getElementById('previewModal').classList.add('open');
}

function showPreviewAt(idx) {
  const file = imgFiles[idx];
  const url = URL.createObjectURL(file);
  const img = document.getElementById('previewImg');
  img.src = url;
  img.onload = () => URL.revokeObjectURL(url);
  document.getElementById('previewTitle').textContent = file.name;
  document.getElementById('previewCounter').textContent = `${idx + 1} / ${imgFiles.length}`;
}

function closePreviewModal() {
  document.getElementById('previewModal').classList.remove('open');
}

function prevPreview() {
  previewIdx = (previewIdx - 1 + imgFiles.length) % imgFiles.length;
  showPreviewAt(previewIdx);
}

function nextPreview() {
  previewIdx = (previewIdx + 1) % imgFiles.length;
  showPreviewAt(previewIdx);
}

// ==========================================
// KEYBOARD SHORTCUTS
// ==========================================
function toggleShortcuts() {
  document.getElementById('shortcutsPanel').classList.toggle('show');
}

document.addEventListener('keydown', e => {
  const tag = document.activeElement.tagName.toLowerCase();
  if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

  switch(e.key) {
    case 'i': case 'I':
      document.getElementById('imgInput').click(); break;
    case 'p': case 'P':
      document.getElementById('pdfInput').click(); break;
    case 'Enter':
      if (!document.getElementById('imgConvertBtn').disabled) window.convertImagesToPDF();
      break;
    case 'Escape':
      document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
      document.getElementById('shortcutsPanel').classList.remove('show');
      break;
    case 'd': case 'D':
      toggleDarkMode(); break;
    case ' ':
      e.preventDefault();
      if (imgFiles.length) openPreview(0);
      break;
    case '?':
      toggleShortcuts(); break;
  }
});

// ==========================================
// IMAGE EDITING (filters, brightness, etc.)
// ==========================================
let activeFilter = 'none';

function setFilter(el, filter) {
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  activeFilter = filter;
}

function updateSliderVal(which) {
  const map = {
    bright:   { slider: 'sliderBright',   val: 'valBright' },
    contrast: { slider: 'sliderContrast', val: 'valContrast' },
    sat:      { slider: 'sliderSat',       val: 'valSat' },
  };
  const v = document.getElementById(map[which].slider).value;
  document.getElementById(map[which].val).textContent = v + '%';
}

function getImageAdjustments() {
  const bright   = document.getElementById('sliderBright') ? document.getElementById('sliderBright').value : 100;
  const contrast = document.getElementById('sliderContrast') ? document.getElementById('sliderContrast').value : 100;
  const sat      = document.getElementById('sliderSat') ? document.getElementById('sliderSat').value : 100;
  const filter   = activeFilter && activeFilter !== 'none' ? activeFilter : '';
  return { bright: parseInt(bright), contrast: parseInt(contrast), sat: parseInt(sat), filter };
}

function getWatermarkConfig() {
  const text = document.getElementById('watermarkText') ? document.getElementById('watermarkText').value.trim() : '';
  const pos  = document.getElementById('watermarkPos') ? document.getElementById('watermarkPos').value : 'center';
  return { text, pos };
}

async function applyAdjustmentsToImage(file, adjustments, watermark) {
  const { bright, contrast, sat, filter } = adjustments;
  const noAdjust = bright === 100 && contrast === 100 && sat === 100 && !filter && !watermark.text;
  if (noAdjust) return null; // no changes needed

  const url = URL.createObjectURL(file);
  const img = await new Promise(res => { const i = new Image(); i.onload = () => { URL.revokeObjectURL(url); res(i); }; i.src = url; });
  const canvas = document.createElement('canvas');
  canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
  const ctx = canvas.getContext('2d');

  // Apply CSS filter via offscreen canvas
  let filterStr = `brightness(${bright}%) contrast(${contrast}%) saturate(${sat}%)`;
  if (filter) filterStr += ' ' + filter;
  ctx.filter = filterStr;
  ctx.drawImage(img, 0, 0);
  ctx.filter = 'none';

  // Watermark
  if (watermark.text) {
    const fs = Math.max(24, Math.round(canvas.width * 0.04));
    ctx.font = `bold ${fs}px sans-serif`;
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = '#ffffff';
    const tw = ctx.measureText(watermark.text).width;
    let wx, wy;
    if (watermark.pos === 'center') {
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(-Math.PI / 6);
      ctx.fillText(watermark.text, -tw/2, fs/2);
      ctx.setTransform(1,0,0,1,0,0);
    } else if (watermark.pos === 'bottom-right') {
      wx = canvas.width - tw - 20; wy = canvas.height - 20;
      ctx.fillText(watermark.text, wx, wy);
    } else {
      wx = 20; wy = fs + 10;
      ctx.fillText(watermark.text, wx, wy);
    }
    ctx.globalAlpha = 1;
  }

  return canvas.toDataURL(file.type === 'image/png' ? 'image/png' : 'image/jpeg', 0.92);
}

// Patch fileToDataURLWithQuality to also apply adjustments
const _origFileToDataURL = fileToDataURLWithQuality;
window.fileToDataURLWithQualityAndFX = async function(file, quality) {
  const adj = getImageAdjustments();
  const wm  = getWatermarkConfig();
  const adjusted = await applyAdjustmentsToImage(file, adj, wm);
  if (adjusted) return adjusted;
  return _origFileToDataURL(file, quality);
};

// ==========================================
// PDF TOOLS ‚Äî Rotate
// ==========================================
function togglePdfTool(tool) {
  const panels = ['rotate','split','extract','info'];
  panels.forEach(p => {
    const card = document.getElementById('tool' + p.charAt(0).toUpperCase() + p.slice(1));
    const sub  = document.getElementById('sub' + p.charAt(0).toUpperCase() + p.slice(1));
    if (p === tool) {
      const isOpen = sub.classList.contains('show');
      sub.classList.toggle('show', !isOpen);
      card.classList.toggle('active-tool', !isOpen);
    } else {
      sub.classList.remove('show');
      card.classList.remove('active-tool');
    }
  });
}

window.rotatePDF = async function(degrees) {
  if (!pdfFile) { showToast('No PDF loaded', 'error'); return; }
  document.getElementById('rotateError').style.display = 'none';
  showToast('‚è≥ Rotating PDF‚Ä¶', 'info', 1500);
  try {
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    while (!window.jspdf && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    const { jsPDF } = window.jspdf;
    const pdfjsLib = window._pdfjs;

    const arrayBuf = await pdfFile.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
    let mergedPdf = null;

    for (let pi = 1; pi <= pdfDoc.numPages; pi++) {
      const page = await pdfDoc.getPage(pi);
      // Render at 2x scale
      const vp0 = page.getViewport({ scale: 2, rotation: 0 });
      const vpR = page.getViewport({ scale: 2, rotation: ((degrees % 360) + 360) % 360 });
      const canvas = document.createElement('canvas');
      canvas.width = vpR.width; canvas.height = vpR.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport: vpR }).promise;
      const pw = vpR.width * 0.264583 / 2, ph = vpR.height * 0.264583 / 2;
      const orient = pw > ph ? 'landscape' : 'portrait';
      if (!mergedPdf) { mergedPdf = new jsPDF({ orientation: orient, unit: 'mm', format: [pw, ph] }); }
      else { mergedPdf.addPage([pw, ph], orient); }
      mergedPdf.addImage(canvas.toDataURL('image/jpeg', 0.92), 'JPEG', 0, 0, pw, ph);
    }
    downloadBlob(mergedPdf.output('blob'), 'rotated.pdf');
    showToast('‚úì Rotated PDF downloaded!', 'success');
  } catch(e) {
    document.getElementById('rotateError').textContent = '‚ö† ' + e.message;
    document.getElementById('rotateError').style.display = 'block';
    showToast('‚ö† Rotation failed', 'error');
  }
};

// ==========================================
// PDF TOOLS ‚Äî Split
// ==========================================
window.splitPDF = async function() {
  if (!pdfFile) { showToast('No PDF loaded', 'error'); return; }
  const rangeStr = document.getElementById('splitRange').value;
  document.getElementById('splitError').style.display = 'none';
  if (!rangeStr.trim()) {
    document.getElementById('splitError').textContent = '‚ö† Enter a page range first';
    document.getElementById('splitError').style.display = 'block';
    return;
  }
  showToast('‚è≥ Splitting PDF‚Ä¶', 'info', 2000);
  try {
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    while (!window.jspdf && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    const { jsPDF } = window.jspdf;
    const pdfjsLib = window._pdfjs;

    const arrayBuf = await pdfFile.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
    const pageNums = parsePageRange(rangeStr, pdfDoc.numPages);
    if (!pageNums.length) throw new Error('Invalid page range');

    let splitPdf = null;
    for (const pi of pageNums) {
      const page = await pdfDoc.getPage(pi);
      const vp = page.getViewport({ scale: 2 });
      const canvas = document.createElement('canvas');
      canvas.width = vp.width; canvas.height = vp.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
      const pw = vp.width * 0.264583 / 2, ph = vp.height * 0.264583 / 2;
      const orient = pw > ph ? 'landscape' : 'portrait';
      if (!splitPdf) { splitPdf = new jsPDF({ orientation: orient, unit: 'mm', format: [pw, ph] }); }
      else { splitPdf.addPage([pw, ph], orient); }
      splitPdf.addImage(canvas.toDataURL('image/jpeg', 0.92), 'JPEG', 0, 0, pw, ph);
    }
    downloadBlob(splitPdf.output('blob'), `split-pages-${rangeStr.replace(/\s/g,'')}.pdf`);
    showToast(`‚úì Split PDF (${pageNums.length} pages) downloaded!`, 'success');
  } catch(e) {
    document.getElementById('splitError').textContent = '‚ö† ' + e.message;
    document.getElementById('splitError').style.display = 'block';
    showToast('‚ö† Split failed', 'error');
  }
};

// ==========================================
// PDF TOOLS ‚Äî Extract Text
// ==========================================
window.extractText = async function() {
  if (!pdfFile) { showToast('No PDF loaded', 'error'); return; }
  showToast('‚è≥ Extracting text‚Ä¶', 'info', 2000);
  try {
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    const pdfjsLib = window._pdfjs;
    const arrayBuf = await pdfFile.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
    let allText = '';
    for (let pi = 1; pi <= pdfDoc.numPages; pi++) {
      const page = await pdfDoc.getPage(pi);
      const content = await page.getTextContent();
      const pageText = content.items.map(item => item.str).join(' ');
      allText += `--- Page ${pi} ---\n${pageText}\n\n`;
    }
    const out = document.getElementById('extractOutput');
    out.value = allText.trim() || '(No readable text found in this PDF)';
    document.getElementById('extractOutputWrap').style.display = 'block';
    showToast('‚úì Text extracted!', 'success');
  } catch(e) {
    showToast('‚ö† Extraction failed: ' + e.message, 'error');
  }
};

window.copyExtractedText = function() {
  navigator.clipboard.writeText(document.getElementById('extractOutput').value);
  showToast('üìã Copied to clipboard!', 'success');
};

window.downloadExtractedText = function() {
  const text = document.getElementById('extractOutput').value;
  const blob = new Blob([text], { type: 'text/plain' });
  downloadBlob(blob, 'extracted-text.txt');
  showToast('‚úì Text file downloaded!', 'success');
};

// ==========================================
// PDF TOOLS ‚Äî Info
// ==========================================
window.showPdfInfo = async function() {
  if (!pdfFile) { showToast('No PDF loaded', 'error'); return; }
  try {
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) { await new Promise(r => setTimeout(r, 200)); attempts++; }
    const pdfjsLib = window._pdfjs;
    const arrayBuf = await pdfFile.arrayBuffer();
    const pdfDoc = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
    const meta = await pdfDoc.getMetadata().catch(() => ({}));
    const page1 = await pdfDoc.getPage(1);
    const vp = page1.getViewport({ scale: 1 });

    const out = document.getElementById('pdfInfoOutput');
    out.innerHTML = `
      <div style="display:grid; grid-template-columns:auto 1fr; gap:4px 16px;">
        <span style="color:var(--muted)">File name</span><span>${pdfFile.name}</span>
        <span style="color:var(--muted)">File size</span><span>${(pdfFile.size/1024).toFixed(1)} KB</span>
        <span style="color:var(--muted)">Pages</span><span>${pdfDoc.numPages}</span>
        <span style="color:var(--muted)">Page size</span><span>${Math.round(vp.width)} √ó ${Math.round(vp.height)} pt</span>
        <span style="color:var(--muted)">Title</span><span>${meta?.info?.Title || '‚Äî'}</span>
        <span style="color:var(--muted)">Author</span><span>${meta?.info?.Author || '‚Äî'}</span>
        <span style="color:var(--muted)">Creator</span><span>${meta?.info?.Creator || '‚Äî'}</span>
      </div>
    `;
    out.style.display = 'block';
    showToast('‚Ñπ PDF info loaded', 'info');
  } catch(e) {
    showToast('‚ö† Could not read PDF info', 'error');
  }
};

// ==========================================
// FIREBASE AUTH FUNCTIONS
// ==========================================
function openAuthModal() {
  document.getElementById('authModal').classList.add('open');
}

function closeAuthModal() {
  document.getElementById('authModal').classList.remove('open');
}

async function signInWithGoogle() {
  try {
    if (!window._firebaseAuth || !window._googleProvider) {
      showToast('‚ö† Firebase not loaded yet, try again', 'error');
      return;
    }
    await window._firebaseSignIn(window._firebaseAuth, window._googleProvider);
    closeAuthModal();
  } catch (e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      showToast('‚ö† Sign-in failed: ' + e.message, 'error');
    }
  }
}

async function signOut() {
  try {
    await window._firebaseSignOut(window._firebaseAuth);
    showToast('üëã Signed out successfully', 'info');
  } catch (e) {
    showToast('‚ö† Sign-out failed', 'error');
  }
}

// Monkey-patch fileToDataURLWithQuality used inside convertImagesToPDF
const _realFileToDataURLWithQuality = fileToDataURLWithQuality;
window._fileToDataURLForConvert = async function(file, quality) {
  const adj = getImageAdjustments();
  const wm  = getWatermarkConfig();
  const adjusted = await applyAdjustmentsToImage(file, adj, wm);
  if (adjusted) return adjusted;
  return _realFileToDataURLWithQuality(file, quality);
};

</script>
</body>
</html>
