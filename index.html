<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morpho</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 44 44'%3E%3Cpath d='M22 22 C18 16,8 10,4 6 C2 4,1 8,3 12 C6 18,14 20,22 22Z' fill='%23d4820a'/%3E%3Cpath d='M22 22 C16 24,6 26,3 32 C1 36,4 40,8 38 C14 34,18 28,22 22Z' fill='%23f59e0b' opacity='.8'/%3E%3Cpath d='M22 22 C26 16,36 10,40 6 C42 4,43 8,41 12 C38 18,30 20,22 22Z' fill='%230d7377'/%3E%3Cpath d='M22 22 C28 24,38 26,41 32 C43 36,40 40,36 38 C30 34,26 28,22 22Z' fill='%2314a0a5' opacity='.8'/%3E%3Cellipse cx='22' cy='22' rx='2' ry='9' fill='%231a1814'/%3E%3Cline x1='21' y1='14' x2='16' y2='5' stroke='%231a1814' stroke-width='1' stroke-linecap='round'/%3E%3Cline x1='23' y1='14' x2='28' y2='5' stroke='%231a1814' stroke-width='1' stroke-linecap='round'/%3E%3Ccircle cx='16' cy='5' r='1.5' fill='%23d4820a'/%3E%3Ccircle cx='28' cy='5' r='1.5' fill='%230d7377'/%3E%3C/svg%3E">
<style>
@import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap');

:root {
  --sand: #f5f0e8;
  --cream: #faf8f3;
  --dark: #1a1814;
  --ink: #2d2a24;
  --muted: #8a8478;
  --line: #e0dbd0;
  --amber: #d4820a;
  --amber-light: #f59e0b;
  --amber-dim: rgba(212,130,10,0.12);
  --teal: #0d7377;
  --teal-light: #14a0a5;
  --teal-dim: rgba(13,115,119,0.12);
  --danger: #c0392b;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--cream);
  color: var(--ink);
  min-height: 100vh;
}

/* ---- Texture overlay ---- */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 999;
  opacity: 0.5;
}

/* ---- Header ---- */
header {
  padding: 24px 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--line);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo-mark {
  width: 44px;
  height: 44px;
  flex-shrink: 0;
}

.logo-text-group {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.logo-word {
  font-family: 'Instrument Serif', serif;
  font-size: 26px;
  color: var(--dark);
  letter-spacing: -0.02em;
  line-height: 1;
}

.logo-word em {
  font-style: italic;
  color: var(--amber);
}

.logo-sub {
  font-size: 11px;
  font-weight: 400;
  color: var(--muted);
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

/* GitHub link in header */
.github-link {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 16px;
  border: 1px solid var(--line);
  border-radius: 8px;
  text-decoration: none;
  color: var(--ink);
  font-size: 13px;
  font-weight: 500;
  transition: all 0.2s ease;
  background: white;
}

.github-link:hover {
  border-color: var(--dark);
  background: var(--dark);
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.github-link svg { transition: fill 0.2s; }
.github-link:hover svg path { fill: white; }

/* ---- Layout ---- */
.workspace {
  display: grid;
  grid-template-columns: 1fr 1fr;
  min-height: calc(100vh - 93px);
}

/* ---- Panel ---- */
.panel {
  padding: 48px;
  border-right: 1px solid var(--line);
  display: flex;
  flex-direction: column;
  gap: 28px;
  position: relative;
}

.panel:last-child { border-right: none; }

/* Vertical label */
.panel-label {
  position: absolute;
  top: 48px;
  right: -1px;
  writing-mode: vertical-rl;
  text-orientation: mixed;
  font-size: 10px;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--muted);
  background: var(--cream);
  padding: 8px 6px;
  border: 1px solid var(--line);
  border-right: none;
}

.panel-title {
  font-family: 'Instrument Serif', serif;
  font-size: 36px;
  line-height: 1.1;
  color: var(--dark);
  letter-spacing: -0.02em;
}

.panel-title .from { color: var(--muted); font-style: italic; font-size: 28px; }
.panel-title .arrow { color: var(--line); font-size: 24px; }

/* ---- Drop zone ---- */
.drop-zone {
  border: 1.5px dashed var(--line);
  border-radius: 12px;
  padding: 40px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s ease;
  background: var(--sand);
  position: relative;
  overflow: hidden;
}

.drop-zone.img-panel { --accent: var(--amber); --accent-dim: var(--amber-dim); }
.drop-zone.pdf-panel { --accent: var(--teal); --accent-dim: var(--teal-dim); }

.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--accent);
  background: var(--accent-dim);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.08);
}

.dz-icon {
  width: 56px; height: 56px;
  margin: 0 auto 16px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 26px;
}

.img-panel .dz-icon { background: var(--amber-dim); }
.pdf-panel .dz-icon { background: var(--teal-dim); }

.dz-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--dark);
  margin-bottom: 4px;
}

.dz-sub {
  font-size: 12px;
  color: var(--muted);
  letter-spacing: 0.05em;
}

/* ---- Options ---- */
.options-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.opt-group {
  flex: 1;
  min-width: 120px;
}

.opt-label {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 6px;
}

select {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid var(--line);
  border-radius: 8px;
  background: white;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  color: var(--ink);
  cursor: pointer;
  outline: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238a8478' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: border-color 0.2s;
}

select:focus { border-color: var(--amber); }

/* ---- File list ---- */
.file-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 240px;
  overflow-y: auto;
}

.file-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: white;
  border: 1px solid var(--line);
  border-radius: 8px;
  transition: all 0.2s;
  animation: item-in 0.25s ease;
}

@keyframes item-in {
  from { opacity: 0; transform: translateX(-8px); }
  to { opacity: 1; transform: translateX(0); }
}

.file-thumb {
  width: 36px; height: 36px;
  border-radius: 6px;
  object-fit: cover;
  flex-shrink: 0;
  background: var(--sand);
  border: 1px solid var(--line);
}

.file-info { flex: 1; min-width: 0; }
.file-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-size { font-size: 11px; color: var(--muted); }

.file-remove {
  width: 24px; height: 24px;
  border: none;
  background: none;
  cursor: pointer;
  color: var(--muted);
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 4px;
  transition: all 0.15s;
  flex-shrink: 0;
}

.file-remove:hover { background: rgba(192,57,43,0.1); color: var(--danger); }

.sort-note {
  font-size: 11px;
  color: var(--muted);
  text-align: center;
  font-style: italic;
}

/* ---- Progress ---- */
.progress-wrap {
  display: none;
}

.progress-bar-bg {
  height: 3px;
  background: var(--line);
  border-radius: 100px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-bar-fill {
  height: 100%;
  border-radius: 100px;
  transition: width 0.3s ease;
  width: 0%;
}

.img-panel .progress-bar-fill { background: linear-gradient(90deg, var(--amber), var(--amber-light)); }
.pdf-panel .progress-bar-fill { background: linear-gradient(90deg, var(--teal), var(--teal-light)); }

.progress-text {
  font-size: 12px;
  color: var(--muted);
  text-align: center;
}

/* ---- Convert button ---- */
.btn-convert {
  padding: 14px 24px;
  border: none;
  border-radius: 10px;
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  letter-spacing: 0.01em;
}

.btn-convert:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

.btn-amber {
  background: var(--amber);
  color: white;
  box-shadow: 0 4px 20px rgba(212,130,10,0.25);
}
.btn-amber:not(:disabled):hover {
  background: #b8710a;
  transform: translateY(-1px);
  box-shadow: 0 8px 28px rgba(212,130,10,0.35);
}

.btn-teal {
  background: var(--teal);
  color: white;
  box-shadow: 0 4px 20px rgba(13,115,119,0.25);
}
.btn-teal:not(:disabled):hover {
  background: #0a5f63;
  transform: translateY(-1px);
  box-shadow: 0 8px 28px rgba(13,115,119,0.35);
}

/* ---- Results ---- */
.results-wrap {
  display: none;
}

.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
}

.result-thumb-wrap {
  position: relative;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--line);
  background: var(--sand);
  aspect-ratio: 3/4;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.result-thumb-wrap:hover { transform: scale(1.03); box-shadow: 0 8px 24px rgba(0,0,0,0.12); }

.result-thumb-wrap img {
  width: 100%; height: 100%;
  object-fit: cover;
}

.result-page-label {
  position: absolute;
  bottom: 4px; left: 4px;
  font-size: 10px;
  font-weight: 600;
  background: rgba(0,0,0,0.6);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
}

.results-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-small {
  padding: 9px 16px;
  border: 1px solid var(--line);
  border-radius: 8px;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  background: white;
  color: var(--ink);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-small:hover { border-color: var(--muted); background: var(--sand); }

.btn-small.primary-amber { background: var(--amber); border-color: var(--amber); color: white; }
.btn-small.primary-amber:hover { background: #b8710a; }
.btn-small.primary-teal { background: var(--teal); border-color: var(--teal); color: white; }
.btn-small.primary-teal:hover { background: #0a5f63; }

/* ---- Error ---- */
.error-msg {
  padding: 12px 16px;
  background: rgba(192,57,43,0.08);
  border: 1px solid rgba(192,57,43,0.25);
  border-radius: 8px;
  font-size: 13px;
  color: var(--danger);
  display: none;
}

/* ---- Divider ---- */
.center-divider {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 40px; height: 40px;
  background: var(--cream);
  border: 1px solid var(--line);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  color: var(--muted);
  z-index: 10;
  pointer-events: none;
}

/* ---- Responsive ---- */
@media (max-width: 768px) {
  header { padding: 16px 24px; }
  .github-link span { display: none; }
  .workspace { grid-template-columns: 1fr; }
  .panel { border-right: none; border-bottom: 1px solid var(--line); padding: 32px 24px; }
  .panel:last-child { border-bottom: none; }
  .panel-label { display: none; }
  .center-divider { display: none; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--line); border-radius: 100px; }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <!-- Morpho Butterfly SVG Logo -->
    <svg class="logo-mark" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Left wing top -->
      <path d="M22 22 C18 16, 8 10, 4 6 C2 4, 1 8, 3 12 C6 18, 14 20, 22 22Z" fill="#d4820a" opacity="0.9"/>
      <!-- Left wing bottom -->
      <path d="M22 22 C16 24, 6 26, 3 32 C1 36, 4 40, 8 38 C14 34, 18 28, 22 22Z" fill="#f59e0b" opacity="0.75"/>
      <!-- Right wing top -->
      <path d="M22 22 C26 16, 36 10, 40 6 C42 4, 43 8, 41 12 C38 18, 30 20, 22 22Z" fill="#0d7377" opacity="0.9"/>
      <!-- Right wing bottom -->
      <path d="M22 22 C28 24, 38 26, 41 32 C43 36, 40 40, 36 38 C30 34, 26 28, 22 22Z" fill="#14a0a5" opacity="0.75"/>
      <!-- Wing shimmer dots -->
      <circle cx="11" cy="14" r="2" fill="white" opacity="0.4"/>
      <circle cx="33" cy="14" r="2" fill="white" opacity="0.4"/>
      <circle cx="9" cy="32" r="1.5" fill="white" opacity="0.3"/>
      <circle cx="35" cy="32" r="1.5" fill="white" opacity="0.3"/>
      <!-- Body -->
      <ellipse cx="22" cy="22" rx="2" ry="9" fill="#1a1814"/>
      <!-- Antennae -->
      <path d="M21 14 Q18 8 16 5" stroke="#1a1814" stroke-width="1" stroke-linecap="round" fill="none"/>
      <path d="M23 14 Q26 8 28 5" stroke="#1a1814" stroke-width="1" stroke-linecap="round" fill="none"/>
      <circle cx="16" cy="5" r="1.2" fill="#d4820a"/>
      <circle cx="28" cy="5" r="1.2" fill="#0d7377"/>
    </svg>

    <div class="logo-text-group">
      <div class="logo-word">Morph<em>o</em></div>
      <div class="logo-sub">Image ‚Üî PDF Converter</div>
    </div>
  </div>

  <a class="github-link" href="https://github.com/kalharanonis0" target="_blank" rel="noopener">
    <svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z" fill="#2d2a24"/>
    </svg>
    <span>View on GitHub</span>
  </a>
</header>

<div class="center-divider">‚áÑ</div>

<div class="workspace">

  <!-- ===== LEFT: Image ‚Üí PDF ===== -->
  <div class="panel" id="imgPanel">
    <div class="panel-label">Image ‚Üí PDF</div>

    <div class="panel-title">
      <span class="from">Image</span><br>
      <span class="arrow">‚Üì</span> PDF
    </div>

    <!-- Drop zone -->
    <div class="drop-zone img-panel" id="imgDropZone" onclick="document.getElementById('imgInput').click()">
      <div class="dz-icon">üñº</div>
      <div class="dz-title">Drop images here</div>
      <div class="dz-sub">JPG ¬∑ PNG ¬∑ WEBP ¬∑ BMP ¬∑ GIF</div>
    </div>
    <input type="file" id="imgInput" accept="image/*" multiple style="display:none">

    <!-- File list -->
    <div id="imgFileList" class="file-list" style="display:none"></div>
    <div class="sort-note" id="imgSortNote" style="display:none">‚Üï Files will appear in order added</div>

    <!-- Options -->
    <div class="options-row" id="imgOptions" style="display:none">
      <div class="opt-group">
        <div class="opt-label">Page Size</div>
        <select id="imgPageSize">
          <option value="a4">A4</option>
          <option value="letter">Letter</option>
          <option value="fit">Fit to Image</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Orientation</div>
        <select id="imgOrientation">
          <option value="auto">Auto</option>
          <option value="portrait">Portrait</option>
          <option value="landscape">Landscape</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Image Fit</div>
        <select id="imgFit">
          <option value="contain">Fit (contain)</option>
          <option value="fill">Fill page</option>
          <option value="original">Original size</option>
        </select>
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-wrap img-panel" id="imgProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="imgProgressBar"></div></div>
      <div class="progress-text" id="imgProgressText">Processing...</div>
    </div>

    <div class="error-msg" id="imgError"></div>

    <!-- Convert button -->
    <button class="btn-convert btn-amber" id="imgConvertBtn" onclick="convertImagesToPDF()" disabled>
      ‚ú¶ Convert to PDF
    </button>

    <!-- Results -->
    <div class="results-wrap" id="imgResults">
      <div class="results-actions">
        <button class="btn-small primary-amber" id="imgDownloadBtn">‚Üì Download PDF</button>
        <button class="btn-small" onclick="resetImg()">‚úï Clear</button>
      </div>
    </div>
  </div>

  <!-- ===== RIGHT: PDF ‚Üí Image ===== -->
  <div class="panel" id="pdfPanel">

    <div class="panel-title">
      <span class="from">PDF</span><br>
      <span class="arrow">‚Üì</span> Images
    </div>

    <!-- Drop zone -->
    <div class="drop-zone pdf-panel" id="pdfDropZone" onclick="document.getElementById('pdfInput').click()">
      <div class="dz-icon">üìÑ</div>
      <div class="dz-title">Drop a PDF here</div>
      <div class="dz-sub">One PDF file</div>
    </div>
    <input type="file" id="pdfInput" accept=".pdf,application/pdf" style="display:none">

    <!-- Options -->
    <div class="options-row" id="pdfOptions" style="display:none">
      <div class="opt-group">
        <div class="opt-label">Output Format</div>
        <select id="pdfFormat">
          <option value="jpeg">JPEG</option>
          <option value="png">PNG</option>
          <option value="webp">WEBP</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Quality</div>
        <select id="pdfQuality">
          <option value="1.5">Standard (1.5x)</option>
          <option value="2" selected>High (2x)</option>
          <option value="3">Ultra (3x)</option>
        </select>
      </div>
      <div class="opt-group">
        <div class="opt-label">Pages</div>
        <select id="pdfPages">
          <option value="all">All pages</option>
          <option value="first">First page only</option>
          <option value="range">Custom range</option>
        </select>
      </div>
    </div>

    <div id="pdfRangeWrap" style="display:none">
      <div class="opt-label" style="margin-bottom:6px">Page Range (e.g. 1-3, 5)</div>
      <input type="text" id="pdfRangeInput" placeholder="1-3, 5, 7"
        style="width:100%;padding:9px 12px;border:1px solid var(--line);border-radius:8px;font-family:'Outfit',sans-serif;font-size:13px;color:var(--ink);outline:none;">
    </div>

    <!-- Progress -->
    <div class="progress-wrap pdf-panel" id="pdfProgress">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="pdfProgressBar"></div></div>
      <div class="progress-text" id="pdfProgressText">Rendering pages...</div>
    </div>

    <div class="error-msg" id="pdfError"></div>

    <!-- Convert button -->
    <button class="btn-convert btn-teal" id="pdfConvertBtn" onclick="convertPDFToImages()" disabled>
      ‚ú¶ Convert to Images
    </button>

    <!-- Results -->
    <div class="results-wrap" id="pdfResults">
      <div class="result-grid" id="pdfResultGrid"></div>
      <div class="results-actions" style="margin-top:12px">
        <button class="btn-small primary-teal" id="pdfDownloadAllBtn">‚Üì Download All (.zip)</button>
        <button class="btn-small" onclick="resetPDF()">‚úï Clear</button>
      </div>
    </div>
  </div>

</div>

<!-- Load libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="module">
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.mjs';
window._pdfjs = pdfjsLib;
</script>
<script>
// ==========================================
// IMAGE ‚Üí PDF
// ==========================================
let imgFiles = [];
let imgPdfBlob = null;

const imgDropZone = document.getElementById('imgDropZone');
const imgInput = document.getElementById('imgInput');
const imgFileList = document.getElementById('imgFileList');
const imgSortNote = document.getElementById('imgSortNote');
const imgOptions = document.getElementById('imgOptions');
const imgConvertBtn = document.getElementById('imgConvertBtn');
const imgProgress = document.getElementById('imgProgress');
const imgProgressBar = document.getElementById('imgProgressBar');
const imgProgressText = document.getElementById('imgProgressText');
const imgResults = document.getElementById('imgResults');
const imgError = document.getElementById('imgError');

// Drag & Drop
imgDropZone.addEventListener('dragover', e => { e.preventDefault(); imgDropZone.classList.add('drag-over'); });
imgDropZone.addEventListener('dragleave', () => imgDropZone.classList.remove('drag-over'));
imgDropZone.addEventListener('drop', e => {
  e.preventDefault(); imgDropZone.classList.remove('drag-over');
  addImageFiles([...e.dataTransfer.files]);
});
imgInput.addEventListener('change', () => addImageFiles([...imgInput.files]));

function addImageFiles(files) {
  const imageFiles = files.filter(f => f.type.startsWith('image/'));
  imgFiles.push(...imageFiles);
  renderImgFileList();
}

function renderImgFileList() {
  imgFileList.innerHTML = '';
  if (imgFiles.length === 0) {
    imgFileList.style.display = 'none';
    imgSortNote.style.display = 'none';
    imgOptions.style.display = 'none';
    imgConvertBtn.disabled = true;
    return;
  }
  imgFileList.style.display = 'flex';
  imgSortNote.style.display = 'block';
  imgOptions.style.display = 'flex';
  imgConvertBtn.disabled = false;

  imgFiles.forEach((file, i) => {
    const item = document.createElement('div');
    item.className = 'file-item';
    const url = URL.createObjectURL(file);
    const thumb = document.createElement('img');
    thumb.className = 'file-thumb';
    thumb.src = url;
    thumb.onload = () => URL.revokeObjectURL(url);

    item.innerHTML = `
      <div class="file-info">
        <div class="file-name">${i+1}. ${file.name}</div>
        <div class="file-size">${(file.size/1024).toFixed(1)} KB</div>
      </div>
      <button class="file-remove" onclick="removeImgFile(${i})">√ó</button>
    `;
    item.insertBefore(thumb, item.firstChild);
    imgFileList.appendChild(item);
  });
}

window.removeImgFile = function(i) {
  imgFiles.splice(i, 1);
  renderImgFileList();
};

window.resetImg = function() {
  imgFiles = []; imgPdfBlob = null;
  imgResults.style.display = 'none';
  imgError.style.display = 'none';
  imgInput.value = '';
  renderImgFileList();
};

window.convertImagesToPDF = async function() {
  if (!imgFiles.length) return;
  imgError.style.display = 'none';
  imgResults.style.display = 'none';
  imgProgress.style.display = 'block';
  imgConvertBtn.disabled = true;

  try {
    // Wait for jsPDF to be available
    let attempts = 0;
    while (!window.jspdf && attempts < 20) {
      await new Promise(r => setTimeout(r, 200));
      attempts++;
    }
    if (!window.jspdf) throw new Error('jsPDF library failed to load');

    const { jsPDF } = window.jspdf;
    const pageSize = document.getElementById('imgPageSize').value;
    const orientation = document.getElementById('imgOrientation').value;
    const fitMode = document.getElementById('imgFit').value;

    // Page dimensions in mm
    const pageSizes = {
      a4: [210, 297],
      letter: [215.9, 279.4],
    };

    let pdf = null;

    for (let i = 0; i < imgFiles.length; i++) {
      imgProgressBar.style.width = Math.round((i / imgFiles.length) * 90) + '%';
      imgProgressText.textContent = `Adding image ${i+1} of ${imgFiles.length}...`;

      const file = imgFiles[i];
      const imgData = await fileToDataURL(file);
      const dims = await getImageDimensions(imgData);

      let pw, ph, orient;

      if (pageSize === 'fit') {
        pw = dims.w * 0.264583; // px to mm at 96dpi
        ph = dims.h * 0.264583;
        orient = pw > ph ? 'landscape' : 'portrait';
      } else {
        [pw, ph] = pageSizes[pageSize];
        orient = orientation === 'auto'
          ? (dims.w > dims.h ? 'landscape' : 'portrait')
          : orientation;
        if (orient === 'landscape') [pw, ph] = [ph, pw];
      }

      if (!pdf) {
        pdf = new jsPDF({ orientation: orient, unit: 'mm', format: pageSize === 'fit' ? [pw, ph] : pageSize });
      } else {
        pdf.addPage(pageSize === 'fit' ? [pw, ph] : pageSize, orient);
      }

      // Calculate image position and size on page
      let iw, ih, ix, iy;
      const margin = 8;
      const aw = pw - margin*2, ah = ph - margin*2;

      if (fitMode === 'fill') {
        iw = pw; ih = ph; ix = 0; iy = 0;
      } else if (fitMode === 'original') {
        iw = Math.min(dims.w * 0.264583, pw);
        ih = (iw / dims.w) * dims.h;
        ix = (pw - iw) / 2;
        iy = (ph - ih) / 2;
      } else {
        // contain
        const scale = Math.min(aw / dims.w, ah / dims.h);
        iw = dims.w * scale;
        ih = dims.h * scale;
        ix = (pw - iw) / 2;
        iy = (ph - ih) / 2;
      }

      const fmt = file.type === 'image/png' ? 'PNG' : 'JPEG';
      pdf.addImage(imgData, fmt, ix, iy, iw, ih);
    }

    imgProgressBar.style.width = '100%';
    imgProgressText.textContent = 'Generating PDF...';

    imgPdfBlob = pdf.output('blob');
    const url = URL.createObjectURL(imgPdfBlob);

    // Download button
    const dlBtn = document.getElementById('imgDownloadBtn');
    dlBtn.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'morpho-converted.pdf';
      a.click();
    };

    setTimeout(() => {
      imgProgress.style.display = 'none';
      imgResults.style.display = 'block';
      imgConvertBtn.disabled = false;
    }, 400);

  } catch(e) {
    imgProgress.style.display = 'none';
    imgConvertBtn.disabled = false;
    imgError.textContent = '‚ö† ' + (e.message || 'Conversion failed');
    imgError.style.display = 'block';
    console.error(e);
  }
};

function fileToDataURL(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

function getImageDimensions(dataURL) {
  return new Promise((res) => {
    const img = new Image();
    img.onload = () => res({ w: img.width, h: img.height });
    img.src = dataURL;
  });
}

// ---- Morpho Branding ----
// Draw Morpho butterfly logo onto a canvas context at (cx,cy) with given size
function drawMorphoLogoOnCanvas(ctx, cx, cy, size) {
  const s = size / 44; // scale factor (logo designed at 44px)
  ctx.save();
  ctx.translate(cx - 22*s, cy - 22*s);
  ctx.scale(s, s);

  // Left wing top ‚Äî amber
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(18, 16, 8, 10, 4, 6);
  ctx.bezierCurveTo(2, 4, 1, 8, 3, 12);
  ctx.bezierCurveTo(6, 18, 14, 20, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(212,130,10,0.92)';
  ctx.fill();

  // Left wing bottom ‚Äî amber light
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(16, 24, 6, 26, 3, 32);
  ctx.bezierCurveTo(1, 36, 4, 40, 8, 38);
  ctx.bezierCurveTo(14, 34, 18, 28, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(245,158,11,0.75)';
  ctx.fill();

  // Right wing top ‚Äî teal
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(26, 16, 36, 10, 40, 6);
  ctx.bezierCurveTo(42, 4, 43, 8, 41, 12);
  ctx.bezierCurveTo(38, 18, 30, 20, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(13,115,119,0.92)';
  ctx.fill();

  // Right wing bottom ‚Äî teal light
  ctx.beginPath();
  ctx.moveTo(22, 22);
  ctx.bezierCurveTo(28, 24, 38, 26, 41, 32);
  ctx.bezierCurveTo(43, 36, 40, 40, 36, 38);
  ctx.bezierCurveTo(30, 34, 26, 28, 22, 22);
  ctx.closePath();
  ctx.fillStyle = 'rgba(20,160,165,0.75)';
  ctx.fill();

  // Shimmer dots
  [[11,14,2,'rgba(255,255,255,0.4)'],[33,14,2,'rgba(255,255,255,0.4)'],
   [9,32,1.5,'rgba(255,255,255,0.3)'],[35,32,1.5,'rgba(255,255,255,0.3)']].forEach(([x,y,r,c]) => {
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle = c; ctx.fill();
  });

  // Body
  ctx.beginPath();
  ctx.ellipse(22, 22, 2, 9, 0, 0, Math.PI*2);
  ctx.fillStyle = '#1a1814';
  ctx.fill();

  // Antennae
  ctx.strokeStyle = '#1a1814';
  ctx.lineWidth = 1;
  ctx.lineCap = 'round';
  ctx.beginPath(); ctx.moveTo(21,14); ctx.quadraticCurveTo(18,8,16,5); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(23,14); ctx.quadraticCurveTo(26,8,28,5); ctx.stroke();

  // Antenna tips
  ctx.beginPath(); ctx.arc(16,5,1.2,0,Math.PI*2); ctx.fillStyle='#d4820a'; ctx.fill();
  ctx.beginPath(); ctx.arc(28,5,1.2,0,Math.PI*2); ctx.fillStyle='#0d7377'; ctx.fill();

  ctx.restore();
}

// Add Morpho branding as last page ‚Äî slim 1.5cm strip (210mm √ó 15mm)
function addMorphoBrandingPageToPDF(pdf) {
  const pw = 210;   // mm ‚Äî A4 width
  const ph = 15;    // mm ‚Äî 1.5cm tall strip

  pdf.addPage([pw, ph], 'portrait');

  // Cream background
  pdf.setFillColor(250, 248, 243);
  pdf.rect(0, 0, pw, ph, 'F');

  // Top & bottom border lines
  pdf.setDrawColor(224, 219, 208);
  pdf.setLineWidth(0.2);
  pdf.line(0, 0.1, pw, 0.1);
  pdf.line(0, ph - 0.1, pw, ph - 0.1);

  // Butterfly logo ‚Äî render at 200px canvas, place at 7.5mm tall centred = 7.5mm
  const logoMM = 8; // logo height/width in mm
  const bc = document.createElement('canvas');
  bc.width = 160; bc.height = 160;
  const bctx = bc.getContext('2d');
  drawMorphoLogoOnCanvas(bctx, 80, 80, 120);
  const bimg = bc.toDataURL('image/png');

  // Lay out: [logo] [Morpho] [¬∑] [Image ‚Üî PDF Converter] ‚Äî all horizontally centred
  // Calculate total content width to centre it
  // Logo: logoMM wide, gap 2mm, "Morpho" ~18mm, gap 2mm, dot 2mm, gap 2mm, tagline ~38mm
  const contentW = logoMM + 2 + 18 + 2 + 2 + 2 + 38;
  let cx = (pw - contentW) / 2;
  const midY = ph / 2;

  // Logo image
  pdf.addImage(bimg, 'PNG', cx, midY - logoMM/2, logoMM, logoMM);
  cx += logoMM + 2.5;

  // "Morpho" bold
  pdf.setFont('helvetica', 'bold');
  pdf.setFontSize(9);
  pdf.setTextColor(26, 24, 20);
  pdf.text('Morpho', cx, midY + 1.5);
  cx += 19;

  // Separator dot
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(180, 175, 165);
  pdf.text('\u00B7', cx, midY + 1.5);
  cx += 3.5;

  // Tagline
  pdf.setFontSize(7.5);
  pdf.setTextColor(138, 132, 120);
  pdf.text('Image \u2194 PDF Converter', cx, midY + 1.5);
}

// Add Morpho watermark overlay onto a rendered page canvas (bottom-right corner)
function addMorphoWatermarkToCanvas(canvas) {
  const ctx = canvas.getContext('2d');
  const pad = 18;
  const logoSize = 32;
  const textH = 11;
  const totalW = logoSize + 6 + 60;
  const totalH = Math.max(logoSize, textH * 2 + 4);
  const x = canvas.width - pad - totalW;
  const y = canvas.height - pad - totalH;

  // Background pill
  const pillW = totalW + 16, pillH = totalH + 10;
  const pillX = canvas.width - pad - pillW;
  const pillY = canvas.height - pad - pillH;
  const r = 10;
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(pillX+r, pillY);
  ctx.lineTo(pillX+pillW-r, pillY);
  ctx.quadraticCurveTo(pillX+pillW, pillY, pillX+pillW, pillY+r);
  ctx.lineTo(pillX+pillW, pillY+pillH-r);
  ctx.quadraticCurveTo(pillX+pillW, pillY+pillH, pillX+pillW-r, pillY+pillH);
  ctx.lineTo(pillX+r, pillY+pillH);
  ctx.quadraticCurveTo(pillX, pillY+pillH, pillX, pillY+pillH-r);
  ctx.lineTo(pillX, pillY+r);
  ctx.quadraticCurveTo(pillX, pillY, pillX+r, pillY);
  ctx.closePath();
  ctx.fillStyle = 'rgba(250,248,243,0.88)';
  ctx.shadowColor = 'rgba(0,0,0,0.12)';
  ctx.shadowBlur = 12;
  ctx.fill();
  ctx.restore();

  // Butterfly logo
  const lx = pillX + 10;
  const ly = pillY + pillH/2;
  drawMorphoLogoOnCanvas(ctx, lx + logoSize/2, ly, logoSize);

  // "Morpho" text
  ctx.save();
  const tx = lx + logoSize + 8;
  const ty = pillY + pillH/2 - 4;
  ctx.font = `bold ${Math.round(canvas.width * 0.012)}px sans-serif`;
  const fs = Math.max(14, Math.min(22, Math.round(canvas.width * 0.014)));
  ctx.font = `bold ${fs}px Georgia, serif`;
  ctx.fillStyle = '#1a1814';
  ctx.fillText('Morpho', tx, ty + fs * 0.75);

  const subFs = Math.max(9, Math.round(fs * 0.6));
  ctx.font = `${subFs}px sans-serif`;
  ctx.fillStyle = '#8a8478';
  ctx.fillText('Image \u2194 PDF', tx, ty + fs * 0.75 + subFs + 3);
  ctx.restore();
}


// ==========================================
// PDF ‚Üí Images
// ==========================================
let pdfRenderedPages = []; // {blob, pageNum}

const pdfDropZone = document.getElementById('pdfDropZone');
const pdfInput = document.getElementById('pdfInput');
const pdfOptions = document.getElementById('pdfOptions');
const pdfConvertBtn = document.getElementById('pdfConvertBtn');
const pdfProgress = document.getElementById('pdfProgress');
const pdfProgressBar = document.getElementById('pdfProgressBar');
const pdfProgressText = document.getElementById('pdfProgressText');
const pdfResults = document.getElementById('pdfResults');
const pdfResultGrid = document.getElementById('pdfResultGrid');
const pdfError = document.getElementById('pdfError');
let pdfFile = null;

pdfDropZone.addEventListener('dragover', e => { e.preventDefault(); pdfDropZone.classList.add('drag-over'); });
pdfDropZone.addEventListener('dragleave', () => pdfDropZone.classList.remove('drag-over'));
pdfDropZone.addEventListener('drop', e => {
  e.preventDefault(); pdfDropZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && (file.type === 'application/pdf' || file.name.endsWith('.pdf'))) setPDFFile(file);
});
pdfInput.addEventListener('change', () => {
  if (pdfInput.files[0]) setPDFFile(pdfInput.files[0]);
});

document.getElementById('pdfPages').addEventListener('change', function() {
  document.getElementById('pdfRangeWrap').style.display = this.value === 'range' ? 'block' : 'none';
});

function setPDFFile(file) {
  pdfFile = file;
  pdfDropZone.querySelector('.dz-title').textContent = file.name;
  pdfDropZone.querySelector('.dz-sub').textContent = (file.size / 1024).toFixed(1) + ' KB';
  pdfOptions.style.display = 'flex';
  pdfConvertBtn.disabled = false;
  pdfResults.style.display = 'none';
  pdfRenderedPages = [];
  pdfError.style.display = 'none';
}

window.resetPDF = function() {
  pdfFile = null; pdfRenderedPages = [];
  pdfDropZone.querySelector('.dz-title').textContent = 'Drop a PDF here';
  pdfDropZone.querySelector('.dz-sub').textContent = 'One PDF file';
  pdfOptions.style.display = 'none';
  pdfConvertBtn.disabled = true;
  pdfResults.style.display = 'none';
  pdfResultGrid.innerHTML = '';
  pdfError.style.display = 'none';
  pdfInput.value = '';
};

window.convertPDFToImages = async function() {
  if (!pdfFile) return;
  pdfError.style.display = 'none';
  pdfResults.style.display = 'none';
  pdfResultGrid.innerHTML = '';
  pdfProgress.style.display = 'block';
  pdfConvertBtn.disabled = true;
  pdfRenderedPages = [];

  try {
    // Wait for PDF.js
    let attempts = 0;
    while (!window._pdfjs && attempts < 30) {
      await new Promise(r => setTimeout(r, 200));
      attempts++;
    }
    if (!window._pdfjs) throw new Error('PDF.js not loaded yet, try again');
    const pdfjsLib = window._pdfjs;

    const fmt = document.getElementById('pdfFormat').value;
    const scale = parseFloat(document.getElementById('pdfQuality').value);
    const pagesMode = document.getElementById('pdfPages').value;

    const arrayBuffer = await pdfFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const total = pdf.numPages;

    // Determine page numbers
    let pageNums = [];
    if (pagesMode === 'first') {
      pageNums = [1];
    } else if (pagesMode === 'range') {
      const rangeStr = document.getElementById('pdfRangeInput').value;
      pageNums = parsePageRange(rangeStr, total);
      if (!pageNums.length) throw new Error('Invalid page range');
    } else {
      pageNums = Array.from({ length: total }, (_, i) => i + 1);
    }

    for (let pi = 0; pi < pageNums.length; pi++) {
      const pageNum = pageNums[pi];
      pdfProgressBar.style.width = Math.round((pi / pageNums.length) * 95) + '%';
      pdfProgressText.textContent = `Rendering page ${pageNum} of ${total}...`;

      const page = await pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      // Add Morpho branding watermark
      addMorphoWatermarkToCanvas(canvas);

      const mimeType = fmt === 'png' ? 'image/png' : fmt === 'webp' ? 'image/webp' : 'image/jpeg';
      const quality = fmt === 'png' ? 1 : 0.92;

      const blob = await new Promise(res => canvas.toBlob(res, mimeType, quality));
      const url = URL.createObjectURL(blob);
      pdfRenderedPages.push({ blob, url, pageNum, fmt });

      // Add to grid
      const wrap = document.createElement('div');
      wrap.className = 'result-thumb-wrap';
      wrap.title = `Click to download page ${pageNum}`;
      wrap.onclick = () => downloadBlob(blob, `page-${pageNum}.${fmt}`);
      const img = document.createElement('img');
      img.src = url;
      const label = document.createElement('div');
      label.className = 'result-page-label';
      label.textContent = 'P' + pageNum;
      wrap.appendChild(img);
      wrap.appendChild(label);
      pdfResultGrid.appendChild(wrap);
    }

    pdfProgressBar.style.width = '100%';

    // Download All button
    const dlAllBtn = document.getElementById('pdfDownloadAllBtn');
    if (pdfRenderedPages.length === 1) {
      dlAllBtn.textContent = '‚Üì Download Image';
      dlAllBtn.onclick = () => downloadBlob(pdfRenderedPages[0].blob, `page-${pdfRenderedPages[0].pageNum}.${pdfRenderedPages[0].fmt}`);
    } else {
      dlAllBtn.textContent = `‚Üì Download All (${pdfRenderedPages.length}) as ZIP`;
      dlAllBtn.onclick = downloadAllImages;
    }

    setTimeout(() => {
      pdfProgress.style.display = 'none';
      pdfResults.style.display = 'block';
      pdfConvertBtn.disabled = false;
    }, 400);

  } catch(e) {
    pdfProgress.style.display = 'none';
    pdfConvertBtn.disabled = false;
    pdfError.textContent = '‚ö† ' + (e.message || 'Conversion failed');
    pdfError.style.display = 'block';
    console.error(e);
  }
};

async function downloadAllImages() {
  const btn = document.getElementById('pdfDownloadAllBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Zipping...';

  // Wait for JSZip
  let attempts = 0;
  while (!window.JSZip && attempts < 20) {
    await new Promise(r => setTimeout(r, 200));
    attempts++;
  }

  const zip = new window.JSZip();
  for (const p of pdfRenderedPages) {
    zip.file(`page-${p.pageNum}.${p.fmt}`, p.blob);
  }
  const zipBlob = await zip.generateAsync({ type: 'blob' });
  downloadBlob(zipBlob, 'pdf-pages.zip');
  btn.disabled = false;
  btn.textContent = `‚Üì Download All (${pdfRenderedPages.length}) as ZIP`;
}

function downloadBlob(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function parsePageRange(str, total) {
  const pages = new Set();
  str.split(',').forEach(part => {
    part = part.trim();
    if (part.includes('-')) {
      let [a, b] = part.split('-').map(Number);
      a = Math.max(1, a); b = Math.min(total, b);
      for (let i = a; i <= b; i++) pages.add(i);
    } else {
      const n = parseInt(part);
      if (!isNaN(n) && n >= 1 && n <= total) pages.add(n);
    }
  });
  return [...pages].sort((a, b) => a - b);
}
</script>
</body>
</html>
